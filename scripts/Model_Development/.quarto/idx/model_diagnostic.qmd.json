{"title":"Ceftolozane-Tazobactam Model Diagnostic","markdown":{"yaml":{"title":"Ceftolozane-Tazobactam Model Diagnostic","author":"Paulina Okunska","date":"today","format":{"html":{"toc":true,"code-fold":true,"number-sections":true,"colorlinks":true}},"execute":{"warning":false},"editor":"visual","theme":"flatly"},"headingText":"Set-up Environment","containsRefs":false,"markdown":"\n\n\n```{r libs, eval=T, echo=F, include=F}\n\nknitr::opts_chunk$set(dpi = 300)\n\n# R packages\n# renv::restore()\n\nlibrary(here)\nlibrary(tidyverse)\nlibrary(rmarkdown)\nlibrary(skimr)\nlibrary(pmplots)\nlibrary(pmtables)\nlibrary(dplyr)\nlibrary(GGally)\nlibrary(bbr)\nlibrary(gridExtra)\nlibrary(patchwork)\nlibrary(nonmem2R)\nlibrary(magrittr)\nlibrary(flextable)\nlibrary(yaml)\nlibrary(yspec)\nlibrary(PKNCA)\nlibrary(ggpubr)\nlibrary(bbr.bayes)\n\n#conflict_scout()\nfilter <- dplyr::filter\nselect <- dplyr::select\ngeomean <- PKNCA::geomean\nadd_summary <- bbr::add_summary\ngroup_rows <- kableExtra::group_rows \nget_legend <- cowplot::get_legend\n\nsource(here(\"scripts/helpers/helper_model_diagnostic.R\"))\n\n#renv::snapshot()\nrenv::status()\n\n```\n\n### Script Parameters\n\n```{r script parameters, eval=T, echo=T}\n\nset.seed(5238974)\nmodel_run <- 100\nspec_name <- \"lookup.yml\"\ndat.name <- \"RawData.csv\"                   \nthisScript <- \"model_diagnostic.qmd\"\n\n\netas <- c(\"ETA-V1C/F\", \"ETA-CLC/F\", \"ETA-Q2C/F\", \"ETA-V2C/F\", \"ETA-V1T/F\",\"ETA-CLT/F\", \"ETA-Q2T/F\", \"ETA-V2T/F\")   \n#etas_est  <- c(\"ETA1//ETA-V1C/F\", \"ETA2//ETA-CLC/F\", \"ETA3//ETA-V1T/F\", \"ETA4//ETA-CLT/F\", \"ETA5//ETA-CORR\")     \netas_est  <- c(\"ETA1//ETA-V1C/F\", \"ETA2//ETA-CLC/F\", \"ETA3//ETA-V1T/F-CLT/F\")\n#etas_est  <- c(\"ETA1//ETA-V1C/F\", \"ETA2//ETA-CLC/F\", \"ETA3//ETA-Q2C/F\", \"ETA4//ETA-V2C/F\", \"ETA5//ETA-V1T/F\", \"ETA6//ETA-CLT/F\", \"ETA7//ETA-Q2T/F\", \"ETA8//ETA-V2T/F\")    \n\n#Directories\nspec_dir <- here::here(\"data/derived\")\nderDir <- here::here(\"data/derived\")\nmodel_dir <- here::here(\"model/nonmem/basic\")\nscripts <- here::here(\"scripts/Model_Development\")\ntab_dir <- here::here(\"deliv/tables/Diagnostic\")\n\noutDir <- paste0(\"model/nonmem/basic/\", model_run)\ndir.create(here::here(outDir, \"model_diagnostic_files\"))\noptions(scipen = 999)\n\n##Continuous Covariates\ncontcov_labels <-c(\"BW//Body Weight (kg)\", \"AGE//Age (years)\", \n                   \"SOFA//Sequential Organ Failure Assessment\", \"PCT//Procalcitonin (ng/mL)\", \n                   \"ELWI//Extravascular lung water index\", \"CI//Cardiac Index (L/min/m2)\", \n                   \"CRE//Creatinine Concentration (mg/dL)\", \"ALB//Albumin Concentration (g/dL)\", \n                   \"PROTEIN//Protein Concentration  (mg/mL)\") #\"HEIGHT//Height (cm)\",\ncontcov_vars <- c(\"BW\", \"AGE\", \"SOFA\", \"PCT\", \"ELWI\", \"CI\", \"CRE\", \"ALB\", \"PROTEIN\") #\"HEIGHT\",\n\n##Categorical Covariates\ncatcov_labels <- c( \"SEX_f//Gender\", \"ECMO_f//ExtraCorporeal Membrane Oxygenation\", \"CRRT_f//Continuous Renal Replacement Therapy\") #\"CMT_f//Drugs\",\ncatcov_vars <- c(\"SEX_f\", \"ECMO_f\", \"CRRT_f\") #\"CMT_f\",\n\n\n```\n\n```{r bbbi}\noptions(bbr.bbi_exe_path = \"C:/Users/pauoku/AppData/Roaming/bbi/bbi.exe\")\n\nbbr::use_bbi()\n\nbbi_init(.dir = model_dir,             # the directory to create the bbi.yaml in\n         .nonmem_dir = \"C:/\",          # location of NONMEM installation\n         .nonmem_version = \"nm75g64\",  # default NONMEM version to use\n.bbi_args = list(\n     mpi_exec_path =\"C:/nm74g64/run/psexec\",\n      parafile = \"C:/nm74g64/run/fpiwini8.pnm\",\n      parallel = FALSE,\n      threads = 1\n    )\n)\n\n```\n\n```{r parm yaml, eval=T, echo=F, include=T, warning=F, message=F}\n\n#Read in Parameters\n## the general parm.yaml file needs to made before running this script\nif(file.exists(file.path(model_dir, model_run, \"parm.yaml\"))){\nkey <- yaml_as_df(file.path(model_dir, model_run, \"parm.yaml\"))\n} else {\n  file.copy(from = file.path(scripts,\"parm.yaml\"),\n            to = file.path(model_dir, model_run, \"parm.yaml\"))\n  file.edit(file.path(model_dir, model_run, \"parm.yaml\"))\n  stop(\"Edit parm.yaml then re-run script\")\n}\n\n```\n\n```{r set theme, eval=T, echo=F, include=F}\n\n##Set ggplot Theme\ntheme_set(theme_bw())\ntheme_update(\n      axis.text = element_text(size = 10),\n      axis.text.x = element_text(size = 6),\n      axis.text.y = element_text(size = 6),\n      axis.title.x = element_text(size = 10),\n      axis.title.y = element_text(size = 10),\n      legend.text = element_text(size = 8),\n      legend.title = element_blank(),\n      legend.position = \"bottom\",\n                panel.grid.major = element_line(color = \"#C8C9C7\", linetype = \"dotdash\"),\n                panel.grid.minor = element_line(color = \"#C8C9C7\", linetype = \"dotdash\"))\n              #  panel.background = element_rect(fill = \"white\", color = \"#1E63AF\"))\n\n#Theme for statistics\ngofcol <- c('GeoMean Observed'='#073763','GeoMean IPRED'='#40904e','GeoMean PRED'='#e04f23')\ngofcol2 <- c('Median Observed'='#073763','Median IPRED'='#40904e','Median PRED'='#e04f23')\ndrugs <- c(\"Ceftolozan\" = \"#a93226\", \"Tazabaktam\" =\"#145a32\")\n\n#adjust table size in output file\nFitFlextableToPage <- function(ft, pgwidth = 6){\n  ft_out <- ft %>% autofit()\n  ft_out <- width(ft_out, width = dim(ft_out)$widths*pgwidth /(flextable_dim(ft_out)$widths))\n  return(ft_out)\n}\n\n```\n\n# Read Inputs\n\n```{r mod-read, eval=T, echo=F, include=F}\n#Read in Model\nmod <- read_model(here::here(model_dir, model_run))\nsum <- mod %>% model_summary()\n\n#Read in Parameters\nkey <- yaml_as_df(here::here(model_dir, model_run, \"parm.yaml\"))\n\n#Read in Data Spec\nspec <- ys_load(file.path(spec_dir, spec_name))\n\n#Read in the Derived Dataset\n#Note - Observed columns are characters - check data assembly step\nobs <- read_csv(file.path(here(derDir, dat.name)),na = c(\"\", \"NA\", \".\"), show_col_types = FALSE, guess_max = Inf)\n\n\npred <- read.table(here::here(model_dir, model_run, \"PATAB.DAT\"), header = TRUE, skip =1) \n\ncat <- read.table(here::here(model_dir, model_run, \"CATAB.DAT\"), header = TRUE, skip =1) \n\ncont <- read.table(here::here(model_dir, model_run, \"COTAB.DAT\"), header = TRUE, skip =1) \n\nsdtab <- read.table(here::here(model_dir, model_run, \"SDTAB.DAT\"), header = TRUE, skip =1) \n\ndata <- pred %>% \n  inner_join(obs, by = c(\"NUM\", \"ID\")) %>% \n  inner_join(sdtab, by = c(\"NUM\", \"ID\", \"TIME\", \"DV\", \"EVID\", \"CMT\", \"MDV\")) %>% \n  ys_add_factors(.spec = spec) %>% \n  filter(MDV==0)\n\n```\n\n# Parameters\n\n```{r parameters df, eval=T, echo=F, include=T, warning=F, message=F}\n\n# Extract PK parameters and generate values to be displayed for report table ----\nparam_df <- sum  %>%\n  param_estimates() %>%\n  mutate(name = gsub(\"[[:punct:]]\", \"\", parameter_names)) %>%\n  inner_join(key, by = \"name\") %>%    # add names and labels to be used in the table\n  checkTransforms() %>%               # check for associated THETAs (e.g. for logit transformations)\n  defineRows() %>%                    # define series of T/F variables\n  getValueSE() %>%                    # define which value and se are required\n  get95CI() %>%                       # get upper/lower ci - determined using the SE and estimate\n  getpCV() %>%                        # get percent CV\n  getpRSE()   %>%                     # get percent RSE\n  formatValues() %>%                  # back transform as needed, round using' sig' and combine columns where needed\n  formatGreekNames() %>%              # format the labels to display greek symbols\n  getPanelName() %>%                  # Define panel names based on parameter type\n  dplyr::select(type, abb, greek, desc, value,estimate, ci, cv,upper, lower, corr_SD, pRSE,shrinkage) %>%  # select columns of interest\n  as.data.frame() %>% \n  select(-upper, -lower, -estimate)\n\n#Paste CV to value column\n#param_df$value <- ifelse(param_df$cv!=\"-\",paste0(param_df$value,\" [CV%=\",param_df$cv,\"]\"), param_df$value)\nparam_df <- subset(param_df, select = c(-cv, -corr_SD))\n\n# Define footnotes ---------------------------- ----------------------------\nfootAbbrev = \"Abbreviations: CI = confidence intervals;\n                        RSE = relative standard error;\n                        CV = coefficient of variation;\n                        SD = standard deviation\"\nfootAbbrev_Om = \"Abbreviations: CI = confidence intervals;\n                        RSE = relative standard error;s\n                        CV = coefficient of variation;\n                        SD = standard deviation\"\n\nfootDerive1 = \"Confidence intervals = estimate $\\\\pm$ 1.96 $\\\\cdot$ SE\"  \nfootDerive2 = \"CV\\\\% of log-normal omegas = sqrt(exp(estimate) - 1) $\\\\cdot$ 100\"\nfootDerive3 = \"CV\\\\% of proportional error = sqrt(estimate) $\\\\cdot$ 100\"\nfootOFVCN = paste0(\"OFV: \",sum$ofv[[1]]$ofv_no_constant, \n                   \" | Condition No: \", round(sum$condition_number[[1]]$condition_number), digits=0)\n\n\n##  FIXED EFFECTS table ----------------------------\nfixed = param_df %>%\n  filter(str_detect(type, \"Struct\") |\n           str_detect(type, \"effect\")) %>%\n  select(-shrinkage) %>%\n  st_new() %>%\n  st_panel(\"type\") %>%\n  st_center(desc = col_ragged(5.5),\n            abb = \"l\") %>%\n  st_blank(\"abb\", \"greek\", \"desc\") %>%\n  st_rename(\"Estimate\" = \"value\",\n            \"95\\\\% CI\" = \"ci\",\n            \"RSE (\\\\%)\"=\"pRSE\") %>%\n  st_files(output = \"pk-param-final-fixed.tex\") %>%\n  st_notes(footAbbrev, footDerive1, footOFVCN) %>%\n  st_noteconf(type = \"minipage\", width = 1) %>%\n  stable() %>%  st_as_image()\n\nfixed\n # st_aspdf(dir = file.path(model_dir,model_run, stem = \"fixed_parm_base\"))\n\n##  RANDOM EFFECTS table ----------------------------\nrandom = param_df %>%\n  filter(str_detect(greek, \"Omega\") |\n           str_detect(type, \"Resid\")) %>%\n  select(-desc) %>%\n  st_new %>%\n  st_panel(\"type\") %>%\n  st_center(abb = \"l\") %>%\n  st_blank(\"abb\", \"greek\") %>%\n  st_rename(\"Estimate\" = \"value\",\n            \"95\\\\% CI\" = \"ci\",\n            \"Shrinkage (\\\\%)\" = \"shrinkage\",\n            \"RSE (\\\\%)\"=\"pRSE\") %>%\n  st_files(output = \"pk-param-final-random.tex\") %>%\n  st_notes(footAbbrev_Om, footDerive2, footDerive3) %>%\n  st_noteconf(type = \"minipage\", width = 1) %>%\n  stable() %>% st_as_image()\n\nrandom\n # st_aspdf(dir = file.path(model_dir,model_run, stem = \"random_parm_base\"))\n\n```\n\n# Model Summary\n\n```{r flexible to page table, eval=T, echo=F, include=T, warning=F, message=F}\n\n#Model Summary \nsum\nsum$ofv\nsum$condition_number\n\nsum_tab <- FitFlextableToPage(flextable(param_df %>% \n                             select(-type, -greek) %>% \n                             rename(\"Name\" = \"abb\",\n                                    \"Description\" = \"desc\",\n                                    \"Estimate\" = \"value\",\n                                    `95% CI` = \"ci\",\n                                    `RSE (%)` = \"pRSE\",\n                                    `Shrinkage (%)`= \"shrinkage\")))\nsum_tab\n\n##sum_tab %>%\n##  save_as_image(path = here::here(outDir, \"model_summary.png\"))\n\n```\n\n# Concordance Plots\n\n## IPRED/PRED vs DV\n\n```{r predictions vs conc, eval=T, echo=F, include=T, warning=F, message=F,fig.width = 10, fig.height = 6, dpi=300}\n\npred <- data %>% select(NUM, TIME, DV, PRED, IPRED, WRES, CWRES, CMT, NPDE)\nsub <- data %>% \n  arrange(ID, TIME) %>% \n  mutate(RES = DV-PRED) \n\nmaxconc <- max(sub$IPRED, sub$PRED, sub$DV,na.rm = TRUE)\n\n# colored by drugs \nc1 <- ggplot(sub, aes(IPRED, DV, color = as.factor(CMT_f))) + geom_point() + geom_abline() + scale_colour_manual(values = drugs) + guides(color = guide_legend(title = NULL))\nc2 <- ggplot(sub, aes(PRED, DV, color = as.factor(CMT_f))) + geom_point() + geom_abline() + scale_colour_manual(values = drugs) + guides(color = guide_legend(title = NULL))\nc3 <- dv_ipred(sub, yname = \"concentration (mg/mL)\") + geom_point(aes(color = CMT_f)) + theme() + scale_colour_manual(values = drugs) + guides(color = guide_legend(nrow = 1, title = NULL)) \nc4 <- dv_pred(sub, yname = \"concentration (mg/mL)\") + geom_point(aes(color = CMT_f)) + theme() + scale_colour_manual(values = drugs) + guides(color = guide_legend(nrow = 1, title = NULL)) \n\n\n\nlist(c1 + xlim(0, maxconc) + ylim(0, maxconc) + labs(caption = \"Linear scale\"),\n       c1 + scale_y_log10(limits = c(0.5, 1000)) + scale_x_log10(limits = c(0.5, 1000)) + labs(caption = \"log-log scale\")) %>% pm_grid() + plot_layout(guides = \"collect\") \n##ggsave(here::here(outDir,\"IPRED_DV_by_dose.png\"), width = 10, height = 6)\n\nlist(c2 + xlim(0,maxconc) + ylim(0,maxconc) + labs(caption = \"Linear scale\"),\n       c2 + scale_y_log10(limits = c(0.5, 1000)) + scale_x_log10(limits = c(0.5, 1000)) + labs(caption = \"log-log scale\")) %>% pm_grid() + plot_layout(guides = \"collect\") \n##ggsave(here::here(outDir,\"PRED_DV_by_dose.png\"), width = 10, height = 6)\n\nlist(c3 + xlim(0, maxconc) + ylim(0, maxconc) + labs(caption = \"Linear scale\"),\n       c3 + scale_y_log10(limits = c(0.5, 1000)) + scale_x_log10(limits = c(0.5, 1000)) + labs(caption = \"log-log scale\")) %>% pm_grid() + plot_layout(guides = \"collect\") + guides(color = guide_legend(nrow = 1, title = NULL)) \n##ggsave(here::here(outDir,\"IPRED_DV_by_dose_second.png\"), width = 10, height = 6)\n\nlist(c4 + xlim(0, maxconc) + ylim(0, maxconc) + labs(caption = \"Linear scale\"),\n       c4 + scale_y_log10(limits = c(0.5, 1000)) + scale_x_log10(limits = c(0.5, 1000)) + labs(caption = \"log-log scale\")) %>% pm_grid() + plot_layout(guides = \"collect\") + guides(color = guide_legend(nrow = 1, title = NULL)) \n##ggsave(here::here(outDir,\"PRED_DV_by_dose_second.png\"), width = 10, height = 6)\n\n```\n\n```{r concordance_all, eval=T, echo=F, include=T, warning=F, message=F,dpi=300}\n\nc1 <- dv_pred(pred, yname = \"(mg/mL)\") + theme(plot.margin = unit(c(0.1, 1, 0.1, 0.1), \"cm\"))  \nc2 <- dv_ipred(pred, yname = \"(mg/mL)\") + labs(caption = \"Linear scale\") + theme(plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), \"cm\"))  \n\nlist(c1,c2) %>% pm_grid()\n\nc3 <- dv_pred(pred, yname = \"(mg/mL)\", loglog=TRUE)  + theme(axis.text.x=element_text(size=7.5)) + theme(plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), \"cm\"))  \nc4 <- dv_ipred(pred, yname = \"(mg/mL)\", loglog=TRUE) + theme(axis.text.x=element_text(size=7.5)) + labs(caption = \"Semi-log scale\") + theme(plot.margin = unit(c(0.1, 1, 0.1, 0.1), \"cm\"))  \n\nlist(c3,c4) %>% pm_grid()\nlist(c1,c2,c3,c4) %>% pm_grid() \n\n\n```\n\n## Ceftolozane\n\n```{r concordance_cef, eval=T, echo=F, include=T, warning=F, message=F,dpi=300}\n\nc1 <- dv_pred(pred %>% filter(CMT == 1), yname = \"(mg/mL)\") + theme(plot.margin = unit(c(0.1, 1, 0.1, 0.1), \"cm\"))  \nc2 <- dv_ipred(pred %>% filter(CMT == 1), yname = \"(mg/mL)\") + labs(caption = \"Linear scale\") + theme(plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), \"cm\"))  \n\nlist(c1,c2) %>% pm_grid() + plot_annotation(title = \"Ceftolozane\")\n\nc3 <- dv_pred(pred %>% filter(CMT == 1), yname = \"(mg/mL)\", loglog=TRUE)  + theme(axis.text.x=element_text(size=7.5)) + theme(plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), \"cm\"))  \nc4 <- dv_ipred(pred %>% filter(CMT == 1), yname = \"(mg/mL)\", loglog=TRUE) + theme(axis.text.x=element_text(size=7.5)) + labs(caption = \"Semi-log scale\") + theme(plot.margin = unit(c(0.1, 1, 0.1, 0.1), \"cm\"))  \n\nlist(c3,c4) %>% pm_grid() + plot_annotation(title = \"Ceftolozane\")\nlist(c1,c2,c3,c4) %>% pm_grid() + plot_annotation(title = \"Ceftolozane\")\n\n\n```\n\n## Tazobactam\n\n```{r concordance_taz, eval=T, echo=F, include=T, warning=F, message=F,dpi=300}\n\nc1 <- dv_pred(pred %>% filter(CMT == 3), yname = \"(mg/mL)\") + theme(plot.margin = unit(c(0.1, 1, 0.1, 0.1), \"cm\"))  \nc2 <- dv_ipred(pred %>% filter(CMT == 3), yname = \"(mg/mL)\") + labs(caption = \"Linear scale\") + theme(plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), \"cm\"))  \n\nlist(c1,c2) %>% pm_grid() + plot_annotation(title = \"Tazobactam\")\n\nc3 <- dv_pred(pred %>% filter(CMT == 3), yname = \"(mg/mL)\", loglog=TRUE)  + theme(axis.text.x=element_text(size=7.5)) + theme(plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), \"cm\"))  \nc4 <- dv_ipred(pred %>% filter(CMT == 3), yname = \"(mg/mL)\", loglog=TRUE) + theme(axis.text.x=element_text(size=7.5)) + labs(caption = \"Semi-log scale\") + theme(plot.margin = unit(c(0.1, 1, 0.1, 0.1), \"cm\"))  \n\nlist(c3,c4) %>% pm_grid() + plot_annotation(title = \"Tazobactam\")\nlist(c1,c2,c3,c4) %>% pm_grid() + plot_annotation(title = \"Tazobactam\")\n\n```\n\n# Residual Plots\n\n```{r residual plots, eval=T, echo=F, include=T, warning=F, message=F,fig.width = 10, fig.height = 8, dpi=300}\n#ALL\nsub1 <- sub \n  r1 <- ggplot(sub1, aes(PRED, WRES)) + geom_point(aes(color = as.factor(CMT_f))) + geom_hline(yintercept = 0) + geom_smooth() + labs(y = \"Weighted Residuals\", x = expression(\" \")) + scale_colour_manual(values = drugs)\n  r2 <- ggplot(sub1, aes(PRED, CWRES)) + geom_point(aes(color = as.factor(CMT_f))) + geom_hline(yintercept = 0) + geom_smooth() + labs(y = \"Conditional Weighted Residuals\", x = expression(\" \")) + scale_colour_manual(values = drugs)\n  r3 <- ggplot(sub1, aes(TIME, WRES)) + geom_point(aes(color = as.factor(CMT_f))) + geom_hline(yintercept = 0) + geom_smooth() + labs(y = \" \", x = expression(\" \")) + scale_colour_manual(values = drugs) + scale_x_continuous(breaks = seq(0, 26, by = 4))\n  r4 <- ggplot(sub1, aes(TIME, CWRES)) + geom_point(aes(color = as.factor(CMT_f))) + geom_hline(yintercept = 0) + geom_smooth() + labs(y = \"\", x = \" \") + scale_colour_manual(values = drugs) + scale_x_continuous(breaks = seq(0, 26, by = 4))\n  r5 <- ggplot(sub1, aes(PRED, NPDE)) + geom_point(aes(color = as.factor(CMT_f))) + geom_hline(yintercept = 0) + geom_smooth() + labs(y = \"Normalized prediction distribution errors\", x = expression(\"Population Predicted Concentrations (mg/mL)\")) + scale_colour_manual(values = drugs)\n  r6 <- ggplot(sub1, aes(TIME, NPDE)) + geom_point(aes(color = as.factor(CMT_f))) + geom_hline(yintercept = 0) + geom_smooth() + labs(y = \" \", x = expression(\"Time After Last Dose (hr)\")) + scale_colour_manual(values = drugs) + scale_x_continuous(breaks = seq(0, 26, by = 4))\n \n   list(r1,r3,r2,r4,r5,r6) %>% pm_grid() \n\n#CEF   \nsub1 <- sub %>% filter(CMT == 1)\n  r1 <- ggplot(sub1, aes(PRED, WRES)) + geom_point() + geom_hline(yintercept = 0) + geom_smooth() +\n  labs(y = \"Weighted Residuals\", x = expression(\" \"))\n  r2 <- ggplot(sub1, aes(PRED, CWRES)) + geom_point() + geom_hline(yintercept = 0) + geom_smooth() +\n     labs(y = \"Conditional Weighted Residuals\", x = expression(\" \"))\n  r3 <- ggplot(sub1, aes(TIME, WRES)) + geom_point() + geom_hline(yintercept = 0) + geom_smooth() + labs(y = \" \", x = expression(\" \")) + scale_x_continuous(breaks = seq(0, 26, by = 4))\n  r4 <- ggplot(sub1, aes(TIME, CWRES)) + geom_point() + geom_hline(yintercept = 0) + geom_smooth() +\n     labs(y = \"\", x = \" \") + scale_x_continuous(breaks = seq(0, 26, by = 4))\n  r5 <- ggplot(sub1, aes(PRED, NPDE)) + geom_point() + geom_hline(yintercept = 0) + geom_smooth() + labs(y = \"Normalized prediction distribution errors\", x = expression(\"Population Predicted Concentrations (mg/mL)\"))\n  r6 <- ggplot(sub1, aes(TIME, NPDE)) + geom_point() + geom_hline(yintercept = 0) + geom_smooth() + labs(y = \" \", x = expression(\"Time After First Dose (hr)\")) + scale_x_continuous(breaks = seq(0, 26, by = 4))\n \n   list(r1,r3,r2,r4,r5,r6) %>% pm_grid() + plot_annotation(title = \"Ceftolozane\")\n   \n     \n##ggsave(here::here(outDir,\"residual_plots.png\"), width = 8, height = 6)\n   \n#TAZ \n   sub1 <- sub %>% filter(CMT == 3)\n  r1 <- ggplot(sub1, aes(PRED, WRES)) + geom_point() + geom_hline(yintercept = 0) + geom_smooth() +\n  labs(y = \"Weighted Residuals\", x = expression(\" \"))\n  r2 <- ggplot(sub1, aes(PRED, CWRES)) + geom_point() + geom_hline(yintercept = 0) + geom_smooth() +\n     labs(y = \"Conditional Weighted Residuals\", x = expression(\" \"))\n  r3 <- ggplot(sub1, aes(TIME, WRES)) + geom_point() + geom_hline(yintercept = 0) + geom_smooth() + labs(y = \" \", x = expression(\" \")) + scale_x_continuous(breaks = seq(0, 26, by = 4))\n  r4 <- ggplot(sub1, aes(TIME, CWRES)) + geom_point() + geom_hline(yintercept = 0) + geom_smooth() +\n     labs(y = \"\", x = \" \") + scale_x_continuous(breaks = seq(0, 26, by = 4))\n  r5 <- ggplot(sub1, aes(PRED, NPDE)) + geom_point() + geom_hline(yintercept = 0) + geom_smooth() + labs(y = \"Normalized prediction distribution errors\", x = expression(\"Population Predicted Concentrations (mg/mL)\"))\n  r6 <- ggplot(sub1, aes(TIME, NPDE)) + geom_point() + geom_hline(yintercept = 0) + geom_smooth() + labs(y = \" \", x = expression(\"Time after first dose (hr)\")) + scale_x_continuous(breaks = seq(0, 26, by = 4))\n \n   list(r1,r3,r2,r4,r5,r6) %>% pm_grid() + plot_annotation(title = \"Tazobactam\")\n\n```\n\n```{r resid_plots_final, eval=T, echo=F, include=T, warning=F, message=F,fig.width = 10, fig.height = 8,dpi=300}\n#ALL(single for Report)  \n   sub1 <- sub \n  r1 <- ggplot(sub1, aes(PRED, WRES)) + geom_point(aes(color = as.factor(CMT_f)), size = 2) + geom_hline(yintercept = 0) + geom_smooth() + labs(y = \"Weighted Residuals\", x = \"Population Predicted Concentrations (mg/mL)\") + theme(axis.title.x = element_text(size = 16), axis.text.x = element_text(size = 14),  axis.title.y = element_text(size = 16), axis.text.y = element_text(size = 12), legend.text = element_text(size = 14)) + scale_colour_manual(values = drugs)\n\n    r2 <- ggplot(sub1, aes(PRED, CWRES)) + geom_point(aes(color = as.factor(CMT_f)), size = 2) + geom_hline(yintercept = 0) + geom_smooth() + labs(y = \"Conditional Weighted Residuals\", x = \"Population Predicted Concentrations (mg/mL)\")+ theme(axis.title.x = element_text(size = 16), axis.text.x = element_text(size = 14),  axis.title.y = element_text(size = 16), axis.text.y = element_text(size = 12),legend.text = element_text(size = 14)) + scale_colour_manual(values = drugs)\n\n      r3 <- ggplot(sub1, aes(TIME, WRES)) + geom_point(aes(color = as.factor(CMT_f)), size = 2) + geom_hline(yintercept = 0) + geom_smooth() + labs(y = \"Weighted Residuals\", x = \"Time after first dose (hr)\")+ theme(axis.title.x = element_text(size = 16), axis.text.x = element_text(size = 14),  axis.title.y = element_text(size = 16), axis.text.y = element_text(size = 12), legend.text = element_text(size = 14)) + scale_colour_manual(values = drugs) + scale_x_continuous(breaks = seq(0, 26, by = 4))\n\n        r4 <- ggplot(sub1, aes(TIME, CWRES)) + geom_point(aes(color = as.factor(CMT_f)), size = 2) + geom_hline(yintercept = 0) + geom_smooth() + labs(y = \"Conditional Weighted Residuals\", x = \"Time after first dose (hr)\")+ theme(axis.title.x = element_text(size = 16), axis.text.x = element_text(size = 14),  axis.title.y = element_text(size = 16), axis.text.y = element_text(size = 12),legend.text = element_text(size = 14)) + scale_colour_manual(values = drugs) + scale_x_continuous(breaks = seq(0, 26, by = 4))\n\n          r5 <- ggplot(sub1, aes(PRED, NPDE)) + geom_point(aes(color = as.factor(CMT_f)), size = 2) + geom_hline(yintercept = 0) + geom_smooth() + labs(y = \"Normalized prediction distribution errors\", x = \"Population Predicted Concentrations (mg/mL)\")+ theme(axis.title.x = element_text(size = 16), axis.text.x = element_text(size = 14),  axis.title.y = element_text(size = 16), axis.text.y = element_text(size = 12), legend.text = element_text(size = 14)) + scale_colour_manual(values = drugs)\n\n            r6 <- ggplot(sub1, aes(TIME, NPDE)) + geom_point(aes(color = as.factor(CMT_f)), size = 2) + geom_hline(yintercept = 0) + geom_smooth() + labs(y = \"Normalized prediction distribution errors\", x = \"Time after first dose (hr)\")+ theme(axis.title.x = element_text(size = 16), axis.text.x = element_text(size = 14),  axis.title.y = element_text(size = 16), axis.text.y = element_text(size = 12), legend.text = element_text(size = 14)) + scale_colour_manual(values = drugs) + scale_x_continuous(breaks = seq(0, 26, by = 4))\n\n  r1\n  r2\n  r3\n  r4\n  r5\n  r6\n\n```\n\n# Histogram Plots and Q-Q Plots\n\n```{r histogram plots, eval=T, echo=F, include=T, warning=F, message=F, dpi=300}\n\nset.ETA.labels(etas_est)\neta.hist.GOF(data)\n##ggsave(here::here(outDir, \"hist_ETA.png\"), width = 8, height = 6)\nh1 <- cwres_hist(data)\nh2 <- wres_hist(data)\nh3 <- npde_hist(data)\nlist(h1, h2, h3) %>% pm_grid()\n##ggsave(here::here(outDir, \"hist_WRES_CWRES.png\"), width = 8, height = 6)\neta.qqnorm.GOF(data)\n##ggsave(here::here(outDir, \"QQ_ETA.png\"), width = 8, height = 6)\n\nh4 <-eta_hist(data, etas_est) %>% pm_grid()\nh4\n\nq1<-cwres_q(data)\nq2<-npde_q(data)\nlist(q1, q2) %>% pm_grid()\n\n```\n\n# GOF Plots\n\n## GeoMean\n\n### Linear\n\n```{r gof linear, eval=T, echo=F, include=T, warning=F, message=F, dpi=300}\n\nsub1 <- sub %>% distinct(CMT_f) \n# sub2 <- sub  %>% mutate(BINTIME = floor(TIME + 0.5))\n\nsub2 <- sub  %>% \n  mutate(x = cut_interval(TIME,10)) %>%\n  group_by(x) %>%\n  mutate(NTIME = mean(TIME))\n\n\ngof <- map(seq(1, nrow(sub1)), function(u){\n  temp <- sub2 %>%\n    filter(CMT_f == sub1[u,1]) %>% \n      group_by(NTIME) %>%\n      mutate(GM_OBS = geomean(DV, na.rm = TRUE),\n             GM_IPRED = geomean(IPRED, na.rm = TRUE),\n             GM_PRED = geomean(PRED, na.rm = TRUE))\n \n  g1 <- ggplot(data = temp, aes(x = TIME, y = DV)) +\n    geom_point(color = \"#093129\", size = 0.9) +\n    geom_line(aes(x = NTIME, y = GM_OBS, color = 'GeoMean Observed'), linewidth = 0.9) +\n    geom_line(aes(x = NTIME, y = GM_IPRED, color = 'GeoMean IPRED'), linewidth = 0.9) +\n    geom_line(aes(x = NTIME, y = GM_PRED, color = 'GeoMean PRED'), linewidth = 0.9) +\n    theme(strip.text.x = element_text(size = 12)) +\n    labs(x = \"Time (hours)\", y = \"Concentration (mg/mL)\", title = (sub1[u,1])) +\n    scale_colour_manual(values = gofcol) +\n    scale_x_continuous(breaks = seq(0, 26, by = 4))\n\n\n  g1 + labs(caption = \"Linear scale\")\n})\n\n##ggexport(gof_atfd, filename = here::here(outDir,\"GOF_plots_atfd_lin.png\"), width = 8, height = 5)\ngof\n\n\n# sub %>%   mutate(BINTIME = cut(TIME, \n#                        breaks = seq(0, max(TIME, na.rm = TRUE) + 1, by = 1), \n#                        labels = 0:(length(seq(0, max(TIME, na.rm = TRUE), by = 1)) - 1), \n#                        right = FALSE)) %>% select(TIME, BINTIME) %>% View()\n```\n\n### Semi-log\n\n```{r gof semilog, eval=T, echo=F, include=T, warning=F, message=F, dpi=300}\n\nsub1 <- sub %>% distinct(CMT_f) \ngof <- map(seq(1, nrow(sub1)), function(u){\n  temp <- sub2 %>%\n    filter(CMT_f == sub1[u,1]) %>% \n      group_by(NTIME) %>%\n      mutate(GM_OBS = geomean(DV, na.rm = TRUE),\n             GM_IPRED = geomean(IPRED, na.rm = TRUE),\n             GM_PRED = geomean(PRED, na.rm = TRUE))\n \n  g1 <- ggplot(data = temp, aes(x = TIME, y = DV)) +\n    geom_point(color = \"#093129\", size = 0.9) +\n    geom_line(aes(x = NTIME, y = GM_OBS, color = 'GeoMean Observed'), linewidth = 0.9) +\n    geom_line(aes(x = NTIME, y = GM_IPRED, color = 'GeoMean IPRED'), linewidth = 0.9) +\n    geom_line(aes(x = NTIME, y = GM_PRED, color = 'GeoMean PRED'), linewidth = 0.9) +\n    theme(strip.text.x = element_text(size = 12)) +\n    labs(x = \"Time (hours)\", y = \"Concentration (mg/mL)\", title = (sub1[u,1])) +\n    scale_colour_manual(values = gofcol) +\n    scale_x_continuous(breaks = seq(0, 26, by = 4))\n    \n\n  g1 + scale_y_log10() + \n    #scale_y_continuous(limits = c(0, 100)) + \n    labs(caption = \"Semi-log scale\")\n})\n\n##ggexport(gof_atfd, filename = here::here(outDir,\"GOF_plots_atfd_lin.png\"), width = 8, height = 5)\ngof\n\n\nlegend <- get_legend(gof[[1]] + theme(legend.position = \"right\") + \n                       guides(color = guide_legend(nrow = 1))) \n pm_grid(gof[[1]]/gof[[2]]) + plot_layout(ncol = 1, heights = c(10, 0.01)) + legend + plot_annotation(title = \"\") & theme(legend.position = \"none\")\n\n```\n\n## Median\n\n### Linear\n\n```{r gof linear median, eval=T, echo=F, include=T, warning=F, message=F, dpi=300}\n\nsub1 <- sub %>% distinct(CMT_f) \ngof <- map(seq(1, nrow(sub1)), function(u){\n  temp <- sub2 %>%\n    filter(CMT_f == sub1[u,1]) %>% \n    group_by(NTIME) %>%\n      mutate(MED_OBS = median(DV, na.rm = TRUE),\n             MED_IPRED = median(IPRED, na.rm = TRUE),\n             MED_PRED = median(PRED, na.rm = TRUE)) \n  \n  g1 <- ggplot(data = temp, aes(x = TIME, y = DV)) +\n    geom_point(color = \"#093129\", size = 0.9) +\n    geom_line(aes(x = NTIME, y = MED_OBS, color = 'Median Observed'), linewidth = 0.9) +\n    geom_line(aes(x = NTIME, y = MED_IPRED, color = 'Median IPRED'), linewidth = 0.9) +\n    geom_line(aes(x = NTIME, y = MED_PRED, color = 'Median PRED'), linewidth = 0.9) +\n    theme(strip.text.x = element_text(size = 12)) +\n    labs(x = \"Time (hours)\", y = \"Concentration (mg/mL)\", title = (sub1[u,1])) +\n    scale_colour_manual(values = gofcol2) +\n    scale_x_continuous(breaks = seq(0, 26, by = 4))\n\n\n  g1 + labs(caption = \"Linear scale\")\n})\n\n##ggexport(gof_atfd, filename = here::here(outDir,\"GOF_plots_atfd_lin.png\"), width = 8, height = 5)\ngof\n\n```\n\n### Semi-log\n\n```{r gof semilog median, eval=T, echo=F, include=T, warning=F, message=F, dpi=300}\n\nsub1 <- sub %>% distinct(CMT_f) \ngof <- map(seq(1, nrow(sub1)), function(u){\n  temp <- sub2 %>%\n    filter(CMT_f == sub1[u,1]) %>% \n    group_by(NTIME) %>%\n      mutate(MED_OBS = median(DV, na.rm = TRUE),\n             MED_IPRED = median(IPRED, na.rm = TRUE),\n             MED_PRED = median(PRED, na.rm = TRUE)) \n  \n  g1 <- ggplot(data = temp, aes(x = TIME, y = DV)) +\n    geom_point(color = \"#093129\", size = 0.9) +\n    geom_line(aes(x = NTIME, y = MED_OBS, color = 'Median Observed'), linewidth = 0.9) +\n    geom_line(aes(x = NTIME, y = MED_IPRED, color = 'Median IPRED'), linewidth = 0.9) +\n    geom_line(aes(x = NTIME, y = MED_PRED, color = 'Median PRED'), linewidth = 0.9) +\n    theme(strip.text.x = element_text(size = 12)) +\n    labs(x = \"Time (hours)\", y = \"Concentration (mg/mL)\", title = (sub1[u,1])) +\n    scale_colour_manual(values = gofcol2) +\n    scale_x_continuous(breaks = seq(0, 26, by = 4))\n  \n  \n  g1 + scale_y_log10() + \n    #scale_y_continuous(limits = c(0, 100)) + \n    labs(caption = \"Semi-log scale\")\n})\n\ngof\n##ggexport(gof_atfd, filename = here::here(outDir, \"GOF_plots_atfd_semilog.png\"), width = 8, height = 5)\n\nlegend <- get_legend(gof[[1]] + theme(legend.position = \"right\") + \n                       guides(color = guide_legend(nrow = 1))) \n pm_grid(gof[[1]]/gof[[2]]) + plot_layout(ncol = 1, heights = c(10, 0.01)) + legend + plot_annotation(title = \"\") & theme(legend.position = \"none\")\n```\n\n## Semi-log individual\n\n```{r gof semilog ind, eval=T, echo=F, include=T, warning=F, message=F, dpi=300}\n\nsub1 <- sub %>% distinct(ID) \ngof_ind <- map(seq(1,nrow(sub1)), function(u){\n  temp <- sub2 %>% \n      group_by(NTIME, CMT_f) %>%\n       mutate(GM_OBS = geomean(DV, na.rm = TRUE),\n             GM_IPRED = geomean(IPRED, na.rm = TRUE),\n             GM_PRED = geomean(PRED, na.rm = TRUE)) %>% \n    # select(ID, DV, TIME, GM_OBS:GM_PRED, CMT_f) %>%  \n    # pivot_longer(GM_OBS:GM_PRED, names_to = \"Stats\", values_to = \"Values\") %>% \n    # pivot_wider(names_from = CMT_f, values_from = Values) %>% \n    filter(ID == sub1[u,1]) \n \n  g1 <- ggplot(data = temp, aes(x = TIME, y = DV)) +\n    geom_point(aes(shape = as.factor(CMT_f)), size = 2.5, color = \"grey33\") +\n    geom_line(aes(x = NTIME, y = GM_OBS, color = 'GeoMean Observed', linetype = as.factor(CMT_f)), linewidth = 0.9) +\n    geom_line(aes(x = NTIME, y = GM_IPRED, color = 'GeoMean IPRED', linetype = as.factor(CMT_f)), linewidth = 0.9) +\n    geom_line(aes(x = NTIME, y = GM_PRED, color = 'GeoMean PRED', linetype = as.factor(CMT_f)), linewidth = 0.9) +\n    theme(strip.text.x = element_text(size = 12)) +\n    labs(x = \"Time (hours)\", y = \"Concentration (mg/mL)\", title = paste0(\"Patient no. \", sub1[u,1])) +\n    scale_colour_manual(values = c(drugs, gofcol)) +\n    scale_x_continuous(breaks = seq(0, 26, by = 4)) +\n    guides(col = guide_legend(nrow = 2), linetype = guide_legend(nrow = 2), shape = guide_legend(nrow = 2))\n\n  g1 + scale_y_log10() + labs(caption = \"Semi-log scale\")\n})\n\ngof_ind\n##ggexport(gof_atfd_ind, filename = here::here(outDir, \"GOF_plots_atfd_semilog_individual.png\"), width = 8, height = 5)\n\n```\n\n# ETA Plots\n\n## ETA Correlations\n\n```{r eta correlations, echo = F, warning = F, message = F, dpi=300}\neta_cor <- data  %>% \n  select(ID, starts_with(\"ETA\")) %>%  \n  rename(\"ETA-V1C/F\" = ETA1, \"ETA-CLC/F\" = ETA2, \"ETA-V1T/F-CLT/F\" = ETA3) %>% \n  # rename(\"ETA-V1C/F\" = ETA1, \"ETA-CLC/F\" = ETA2, \"ETA-Q2C/F\" = ETA3, \"ETA-V2C/F\" = ETA4, \"ETA-V1T/F\" = ETA5, \"ETA-CLT/F\" = ETA6, \"ETA-Q2T/F\" = ETA7, \"ETA-V2T/F\" = ETA8) %>% \n  distinct() %>% \n  select(-ID) \n\nplot_eta_cor <- corrplot::corrplot(cor(eta_cor), method = 'circle', type = \"upper\", addCoef.col = 'grey1', cl.pos = 'r',tl.srt=45, tl.col=\"black\")\n\n##ggexport(plot_eta_cor, filename = here::here(outDir, \"ETA Correlations.png\"), width = 8, height = 5)\n \nid <- distinct(sub, ID, .keep_all = T)\netas <-  stringr::str_subset(names(sub), \"ETA\") \np <- eta_pairs(id, etas_est) \np\n\n```\n\n1m## Categorical ETA plots\n\n```{r cat-eta, eval=T, echo=F, include=T, warning=F, message=F, dpi=300}\n\n#Categorical Covariates\ncat_link <- data %>% #filter(ID%in%sub$ID) %>%\n  select(ID, SEX_f, ECMO_f, CRRT_f) %>% \n  distinct(ID, .keep_all = T) %>% \n  group_by(ID) \n\n dat_cat <- data %>% distinct(ID, .keep_all = T) %>% left_join(cat_link)\n \neta_plots_cat <- eta_cat(dat_cat, catcov_labels, etas_est, points = list(width  = 0.1)) \neta_plots_cat\n#ggsave(eta_plots_cat, filename = here::here(outDir,\"ETA_plots_cat.png\"), width = 6, height = 4)\n\neta_plots_cat1 <- eta_cat(dat_cat, catcov_labels, etas_est[1], points = list(width  = 0.1)) %>% pm_grid()\neta_plots_cat1\n##ggsave(eta_plots_cat1, filename = here::here(outDir,\"ETA_plots_cat1.png\"), width = 6, height = 4)\n\neta_plots_cat2 <- eta_cat(dat_cat, catcov_labels, etas_est[2], points = list(width  = 0.1))  %>% pm_grid()\neta_plots_cat2\n##ggsave(eta_plots_cat2, filename = here::here(outDir,\"ETA_plots_cat2.png\"), width = 6, height = 4)\n\neta_plots_cat3 <- eta_cat(dat_cat, catcov_labels, etas_est[3], points = list(width  = 0.1))  %>% pm_grid() \neta_plots_cat3\n##ggsave(eta_plots_cat5, filename = here::here(outDir,\"ETA_plots_cat5.png\"), width = 6, height = 4)\n\n# eta_plots_cat4 <- eta_cat(dat_cat, catcov_labels, etas_est[4], points = list(width  = 0.1))  %>% pm_grid() \n# eta_plots_cat4\n# ##ggsave(eta_plots_cat5, filename = here::here(outDir,\"ETA_plots_cat5.png\"), width = 6, height = 4)\n# \n# eta_plots_cat5 <- eta_cat(dat_cat, catcov_labels, etas_est[5], points = list(width  = 0.1))  %>% pm_grid() \n# eta_plots_cat5\n# ##ggsave(eta_plots_cat5, filename = here::here(outDir,\"ETA_plots_cat5.png\"), width = 6, height = 4)\n# \n# eta_plots_cat6 <- eta_cat(dat_cat, catcov_labels, etas_est[6], points = list(width  = 0.1))  %>% pm_grid() \n# eta_plots_cat6\n# ##ggsave(eta_plots_cat5, filename = here::here(outDir,\"ETA_plots_cat5.png\"), width = 6, height = 4)\n# \n# eta_plots_cat7 <- eta_cat(dat_cat, catcov_labels, etas_est[7], points = list(width  = 0.1))  %>% pm_grid() \n# eta_plots_cat7\n# ##ggsave(eta_plots_cat5, filename = here::here(outDir,\"ETA_plots_cat5.png\"), width = 6, height = 4)\n# \n# eta_plots_cat8 <- eta_cat(dat_cat, catcov_labels, etas_est[8], points = list(width  = 0.1))  %>% pm_grid() \n# eta_plots_cat8\n# ##ggsave(eta_plots_cat5, filename = here::here(outDir,\"ETA_plots_cat5.png\"), width = 6, height = 4)\n# \n\nwrap_cont_cat(dat_cat, catcov_labels, etas_est, points = list(width  = 0.1)) \n\n```\n\n## Continuous ETA plots\n\n```{r cont-eta, eval=T, echo=F, include=T, warning=F, message=F, dpi=300}\n\n#Continuous Covariates\ncont_link <- data %>% filter(ID%in%sub$ID) %>%\n  select(ID, HEIGHT, BW, AGE, SOFA, PCT, ELWI, CI, CRE, ALB, PROTEIN) %>% distinct() %>%  \n mutate_if(is.numeric, ~replace(., .==-999, NA))\ndat_cont <- data %>% distinct(ID, .keep_all = T)  %>% left_join(cont_link)\n\n\neta_plots_cont <- eta_cont(dat_cont, contcov_labels, etas_est) \n##ggexport(eta_plots_cont, filename = here::here(outDir,\"ETA_plots_cont.png\"), width = 6, height = 4)\neta_plots_cont\n\neta_plots_cont1 <- wrap_eta_cont(dat_cont, contcov_labels, etas_est[1],  scales=\"free\",  use_labels=TRUE)  \n##ggexport(eta_plots_cont1, filename = here::here(outDir,\"ETA_plots_cont_CL.png\"), width = 6, height = 4)\neta_plots_cont1\n\neta_plots_cont2 <- wrap_eta_cont(dat_cont, contcov_labels, etas_est[2],  scales=\"free\",  use_labels=TRUE) \n##ggexport(eta_plots_cont2, filename = here::here(outDir,\"ETA_plots_cont_VC.png\"), width = 6, height = 4)\neta_plots_cont2\n\neta_plots_cont3 <- wrap_eta_cont(dat_cont, contcov_labels, etas_est[3],  scales=\"free\",  use_labels=TRUE)  \n##ggexport(eta_plots_cont5, filename = here::here(outDir,\"ETA_plots_cont_KA.png\"), width = 6, height = 4)\neta_plots_cont3\n\n# eta_plots_cont4 <- wrap_eta_cont(dat_cont, contcov_labels, etas_est[4],  scales=\"free\",  use_labels=TRUE)  \n# ##ggexport(eta_plots_cont5, filename = here::here(outDir,\"ETA_plots_cont_KA.png\"), width = 6, height = 4)\n# eta_plots_cont4\n# \n# eta_plots_cont5 <- wrap_eta_cont(dat_cont, contcov_labels, etas_est[5],  scales=\"free\",  use_labels=TRUE)  \n# ##ggexport(eta_plots_cont5, filename = here::here(outDir,\"ETA_plots_cont_KA.png\"), width = 6, height = 4)\n# eta_plots_cont5\n# \n# eta_plots_cont6 <- wrap_eta_cont(dat_cont, contcov_labels, etas_est[6],  scales=\"free\",  use_labels=TRUE)  \n# ##ggexport(eta_plots_cont5, filename = here::here(outDir,\"ETA_plots_cont_KA.png\"), width = 6, height = 4)\n# eta_plots_cont6\n# \n# eta_plots_cont7 <- wrap_eta_cont(dat_cont, contcov_labels, etas_est[7],  scales=\"free\",  use_labels=TRUE) \n# ##ggexport(eta_plots_cont5, filename = here::here(outDir,\"ETA_plots_cont_KA.png\"), width = 6, height = 4)\n# eta_plots_cont7\n# \n# eta_plots_cont8 <- wrap_eta_cont(dat_cont, contcov_labels, etas_est[8],  scales=\"free\",  use_labels=TRUE)  \n# ##ggexport(eta_plots_cont5, filename = here::here(outDir,\"ETA_plots_cont_KA.png\"), width = 6, height = 4)\n# eta_plots_cont8\n\n# map2(.x = contcov_labels, .y = contcov_vars, \n#      function(xlab, yvar){eta_cont(eta %>% filter(eta[[yvar]]>0), x=xlab , y =etas_est) %>% pm_grid()\n# })\n\n```\n\n# Sesion info\n\n```{r sessioninfo, echo = FALSE, include=TRUE, warning=F, message=F}\n\nsessionInfo()\n\n```\n","srcMarkdownNoYaml":"\n\n# Set-up Environment\n\n```{r libs, eval=T, echo=F, include=F}\n\nknitr::opts_chunk$set(dpi = 300)\n\n# R packages\n# renv::restore()\n\nlibrary(here)\nlibrary(tidyverse)\nlibrary(rmarkdown)\nlibrary(skimr)\nlibrary(pmplots)\nlibrary(pmtables)\nlibrary(dplyr)\nlibrary(GGally)\nlibrary(bbr)\nlibrary(gridExtra)\nlibrary(patchwork)\nlibrary(nonmem2R)\nlibrary(magrittr)\nlibrary(flextable)\nlibrary(yaml)\nlibrary(yspec)\nlibrary(PKNCA)\nlibrary(ggpubr)\nlibrary(bbr.bayes)\n\n#conflict_scout()\nfilter <- dplyr::filter\nselect <- dplyr::select\ngeomean <- PKNCA::geomean\nadd_summary <- bbr::add_summary\ngroup_rows <- kableExtra::group_rows \nget_legend <- cowplot::get_legend\n\nsource(here(\"scripts/helpers/helper_model_diagnostic.R\"))\n\n#renv::snapshot()\nrenv::status()\n\n```\n\n### Script Parameters\n\n```{r script parameters, eval=T, echo=T}\n\nset.seed(5238974)\nmodel_run <- 100\nspec_name <- \"lookup.yml\"\ndat.name <- \"RawData.csv\"                   \nthisScript <- \"model_diagnostic.qmd\"\n\n\netas <- c(\"ETA-V1C/F\", \"ETA-CLC/F\", \"ETA-Q2C/F\", \"ETA-V2C/F\", \"ETA-V1T/F\",\"ETA-CLT/F\", \"ETA-Q2T/F\", \"ETA-V2T/F\")   \n#etas_est  <- c(\"ETA1//ETA-V1C/F\", \"ETA2//ETA-CLC/F\", \"ETA3//ETA-V1T/F\", \"ETA4//ETA-CLT/F\", \"ETA5//ETA-CORR\")     \netas_est  <- c(\"ETA1//ETA-V1C/F\", \"ETA2//ETA-CLC/F\", \"ETA3//ETA-V1T/F-CLT/F\")\n#etas_est  <- c(\"ETA1//ETA-V1C/F\", \"ETA2//ETA-CLC/F\", \"ETA3//ETA-Q2C/F\", \"ETA4//ETA-V2C/F\", \"ETA5//ETA-V1T/F\", \"ETA6//ETA-CLT/F\", \"ETA7//ETA-Q2T/F\", \"ETA8//ETA-V2T/F\")    \n\n#Directories\nspec_dir <- here::here(\"data/derived\")\nderDir <- here::here(\"data/derived\")\nmodel_dir <- here::here(\"model/nonmem/basic\")\nscripts <- here::here(\"scripts/Model_Development\")\ntab_dir <- here::here(\"deliv/tables/Diagnostic\")\n\noutDir <- paste0(\"model/nonmem/basic/\", model_run)\ndir.create(here::here(outDir, \"model_diagnostic_files\"))\noptions(scipen = 999)\n\n##Continuous Covariates\ncontcov_labels <-c(\"BW//Body Weight (kg)\", \"AGE//Age (years)\", \n                   \"SOFA//Sequential Organ Failure Assessment\", \"PCT//Procalcitonin (ng/mL)\", \n                   \"ELWI//Extravascular lung water index\", \"CI//Cardiac Index (L/min/m2)\", \n                   \"CRE//Creatinine Concentration (mg/dL)\", \"ALB//Albumin Concentration (g/dL)\", \n                   \"PROTEIN//Protein Concentration  (mg/mL)\") #\"HEIGHT//Height (cm)\",\ncontcov_vars <- c(\"BW\", \"AGE\", \"SOFA\", \"PCT\", \"ELWI\", \"CI\", \"CRE\", \"ALB\", \"PROTEIN\") #\"HEIGHT\",\n\n##Categorical Covariates\ncatcov_labels <- c( \"SEX_f//Gender\", \"ECMO_f//ExtraCorporeal Membrane Oxygenation\", \"CRRT_f//Continuous Renal Replacement Therapy\") #\"CMT_f//Drugs\",\ncatcov_vars <- c(\"SEX_f\", \"ECMO_f\", \"CRRT_f\") #\"CMT_f\",\n\n\n```\n\n```{r bbbi}\noptions(bbr.bbi_exe_path = \"C:/Users/pauoku/AppData/Roaming/bbi/bbi.exe\")\n\nbbr::use_bbi()\n\nbbi_init(.dir = model_dir,             # the directory to create the bbi.yaml in\n         .nonmem_dir = \"C:/\",          # location of NONMEM installation\n         .nonmem_version = \"nm75g64\",  # default NONMEM version to use\n.bbi_args = list(\n     mpi_exec_path =\"C:/nm74g64/run/psexec\",\n      parafile = \"C:/nm74g64/run/fpiwini8.pnm\",\n      parallel = FALSE,\n      threads = 1\n    )\n)\n\n```\n\n```{r parm yaml, eval=T, echo=F, include=T, warning=F, message=F}\n\n#Read in Parameters\n## the general parm.yaml file needs to made before running this script\nif(file.exists(file.path(model_dir, model_run, \"parm.yaml\"))){\nkey <- yaml_as_df(file.path(model_dir, model_run, \"parm.yaml\"))\n} else {\n  file.copy(from = file.path(scripts,\"parm.yaml\"),\n            to = file.path(model_dir, model_run, \"parm.yaml\"))\n  file.edit(file.path(model_dir, model_run, \"parm.yaml\"))\n  stop(\"Edit parm.yaml then re-run script\")\n}\n\n```\n\n```{r set theme, eval=T, echo=F, include=F}\n\n##Set ggplot Theme\ntheme_set(theme_bw())\ntheme_update(\n      axis.text = element_text(size = 10),\n      axis.text.x = element_text(size = 6),\n      axis.text.y = element_text(size = 6),\n      axis.title.x = element_text(size = 10),\n      axis.title.y = element_text(size = 10),\n      legend.text = element_text(size = 8),\n      legend.title = element_blank(),\n      legend.position = \"bottom\",\n                panel.grid.major = element_line(color = \"#C8C9C7\", linetype = \"dotdash\"),\n                panel.grid.minor = element_line(color = \"#C8C9C7\", linetype = \"dotdash\"))\n              #  panel.background = element_rect(fill = \"white\", color = \"#1E63AF\"))\n\n#Theme for statistics\ngofcol <- c('GeoMean Observed'='#073763','GeoMean IPRED'='#40904e','GeoMean PRED'='#e04f23')\ngofcol2 <- c('Median Observed'='#073763','Median IPRED'='#40904e','Median PRED'='#e04f23')\ndrugs <- c(\"Ceftolozan\" = \"#a93226\", \"Tazabaktam\" =\"#145a32\")\n\n#adjust table size in output file\nFitFlextableToPage <- function(ft, pgwidth = 6){\n  ft_out <- ft %>% autofit()\n  ft_out <- width(ft_out, width = dim(ft_out)$widths*pgwidth /(flextable_dim(ft_out)$widths))\n  return(ft_out)\n}\n\n```\n\n# Read Inputs\n\n```{r mod-read, eval=T, echo=F, include=F}\n#Read in Model\nmod <- read_model(here::here(model_dir, model_run))\nsum <- mod %>% model_summary()\n\n#Read in Parameters\nkey <- yaml_as_df(here::here(model_dir, model_run, \"parm.yaml\"))\n\n#Read in Data Spec\nspec <- ys_load(file.path(spec_dir, spec_name))\n\n#Read in the Derived Dataset\n#Note - Observed columns are characters - check data assembly step\nobs <- read_csv(file.path(here(derDir, dat.name)),na = c(\"\", \"NA\", \".\"), show_col_types = FALSE, guess_max = Inf)\n\n\npred <- read.table(here::here(model_dir, model_run, \"PATAB.DAT\"), header = TRUE, skip =1) \n\ncat <- read.table(here::here(model_dir, model_run, \"CATAB.DAT\"), header = TRUE, skip =1) \n\ncont <- read.table(here::here(model_dir, model_run, \"COTAB.DAT\"), header = TRUE, skip =1) \n\nsdtab <- read.table(here::here(model_dir, model_run, \"SDTAB.DAT\"), header = TRUE, skip =1) \n\ndata <- pred %>% \n  inner_join(obs, by = c(\"NUM\", \"ID\")) %>% \n  inner_join(sdtab, by = c(\"NUM\", \"ID\", \"TIME\", \"DV\", \"EVID\", \"CMT\", \"MDV\")) %>% \n  ys_add_factors(.spec = spec) %>% \n  filter(MDV==0)\n\n```\n\n# Parameters\n\n```{r parameters df, eval=T, echo=F, include=T, warning=F, message=F}\n\n# Extract PK parameters and generate values to be displayed for report table ----\nparam_df <- sum  %>%\n  param_estimates() %>%\n  mutate(name = gsub(\"[[:punct:]]\", \"\", parameter_names)) %>%\n  inner_join(key, by = \"name\") %>%    # add names and labels to be used in the table\n  checkTransforms() %>%               # check for associated THETAs (e.g. for logit transformations)\n  defineRows() %>%                    # define series of T/F variables\n  getValueSE() %>%                    # define which value and se are required\n  get95CI() %>%                       # get upper/lower ci - determined using the SE and estimate\n  getpCV() %>%                        # get percent CV\n  getpRSE()   %>%                     # get percent RSE\n  formatValues() %>%                  # back transform as needed, round using' sig' and combine columns where needed\n  formatGreekNames() %>%              # format the labels to display greek symbols\n  getPanelName() %>%                  # Define panel names based on parameter type\n  dplyr::select(type, abb, greek, desc, value,estimate, ci, cv,upper, lower, corr_SD, pRSE,shrinkage) %>%  # select columns of interest\n  as.data.frame() %>% \n  select(-upper, -lower, -estimate)\n\n#Paste CV to value column\n#param_df$value <- ifelse(param_df$cv!=\"-\",paste0(param_df$value,\" [CV%=\",param_df$cv,\"]\"), param_df$value)\nparam_df <- subset(param_df, select = c(-cv, -corr_SD))\n\n# Define footnotes ---------------------------- ----------------------------\nfootAbbrev = \"Abbreviations: CI = confidence intervals;\n                        RSE = relative standard error;\n                        CV = coefficient of variation;\n                        SD = standard deviation\"\nfootAbbrev_Om = \"Abbreviations: CI = confidence intervals;\n                        RSE = relative standard error;s\n                        CV = coefficient of variation;\n                        SD = standard deviation\"\n\nfootDerive1 = \"Confidence intervals = estimate $\\\\pm$ 1.96 $\\\\cdot$ SE\"  \nfootDerive2 = \"CV\\\\% of log-normal omegas = sqrt(exp(estimate) - 1) $\\\\cdot$ 100\"\nfootDerive3 = \"CV\\\\% of proportional error = sqrt(estimate) $\\\\cdot$ 100\"\nfootOFVCN = paste0(\"OFV: \",sum$ofv[[1]]$ofv_no_constant, \n                   \" | Condition No: \", round(sum$condition_number[[1]]$condition_number), digits=0)\n\n\n##  FIXED EFFECTS table ----------------------------\nfixed = param_df %>%\n  filter(str_detect(type, \"Struct\") |\n           str_detect(type, \"effect\")) %>%\n  select(-shrinkage) %>%\n  st_new() %>%\n  st_panel(\"type\") %>%\n  st_center(desc = col_ragged(5.5),\n            abb = \"l\") %>%\n  st_blank(\"abb\", \"greek\", \"desc\") %>%\n  st_rename(\"Estimate\" = \"value\",\n            \"95\\\\% CI\" = \"ci\",\n            \"RSE (\\\\%)\"=\"pRSE\") %>%\n  st_files(output = \"pk-param-final-fixed.tex\") %>%\n  st_notes(footAbbrev, footDerive1, footOFVCN) %>%\n  st_noteconf(type = \"minipage\", width = 1) %>%\n  stable() %>%  st_as_image()\n\nfixed\n # st_aspdf(dir = file.path(model_dir,model_run, stem = \"fixed_parm_base\"))\n\n##  RANDOM EFFECTS table ----------------------------\nrandom = param_df %>%\n  filter(str_detect(greek, \"Omega\") |\n           str_detect(type, \"Resid\")) %>%\n  select(-desc) %>%\n  st_new %>%\n  st_panel(\"type\") %>%\n  st_center(abb = \"l\") %>%\n  st_blank(\"abb\", \"greek\") %>%\n  st_rename(\"Estimate\" = \"value\",\n            \"95\\\\% CI\" = \"ci\",\n            \"Shrinkage (\\\\%)\" = \"shrinkage\",\n            \"RSE (\\\\%)\"=\"pRSE\") %>%\n  st_files(output = \"pk-param-final-random.tex\") %>%\n  st_notes(footAbbrev_Om, footDerive2, footDerive3) %>%\n  st_noteconf(type = \"minipage\", width = 1) %>%\n  stable() %>% st_as_image()\n\nrandom\n # st_aspdf(dir = file.path(model_dir,model_run, stem = \"random_parm_base\"))\n\n```\n\n# Model Summary\n\n```{r flexible to page table, eval=T, echo=F, include=T, warning=F, message=F}\n\n#Model Summary \nsum\nsum$ofv\nsum$condition_number\n\nsum_tab <- FitFlextableToPage(flextable(param_df %>% \n                             select(-type, -greek) %>% \n                             rename(\"Name\" = \"abb\",\n                                    \"Description\" = \"desc\",\n                                    \"Estimate\" = \"value\",\n                                    `95% CI` = \"ci\",\n                                    `RSE (%)` = \"pRSE\",\n                                    `Shrinkage (%)`= \"shrinkage\")))\nsum_tab\n\n##sum_tab %>%\n##  save_as_image(path = here::here(outDir, \"model_summary.png\"))\n\n```\n\n# Concordance Plots\n\n## IPRED/PRED vs DV\n\n```{r predictions vs conc, eval=T, echo=F, include=T, warning=F, message=F,fig.width = 10, fig.height = 6, dpi=300}\n\npred <- data %>% select(NUM, TIME, DV, PRED, IPRED, WRES, CWRES, CMT, NPDE)\nsub <- data %>% \n  arrange(ID, TIME) %>% \n  mutate(RES = DV-PRED) \n\nmaxconc <- max(sub$IPRED, sub$PRED, sub$DV,na.rm = TRUE)\n\n# colored by drugs \nc1 <- ggplot(sub, aes(IPRED, DV, color = as.factor(CMT_f))) + geom_point() + geom_abline() + scale_colour_manual(values = drugs) + guides(color = guide_legend(title = NULL))\nc2 <- ggplot(sub, aes(PRED, DV, color = as.factor(CMT_f))) + geom_point() + geom_abline() + scale_colour_manual(values = drugs) + guides(color = guide_legend(title = NULL))\nc3 <- dv_ipred(sub, yname = \"concentration (mg/mL)\") + geom_point(aes(color = CMT_f)) + theme() + scale_colour_manual(values = drugs) + guides(color = guide_legend(nrow = 1, title = NULL)) \nc4 <- dv_pred(sub, yname = \"concentration (mg/mL)\") + geom_point(aes(color = CMT_f)) + theme() + scale_colour_manual(values = drugs) + guides(color = guide_legend(nrow = 1, title = NULL)) \n\n\n\nlist(c1 + xlim(0, maxconc) + ylim(0, maxconc) + labs(caption = \"Linear scale\"),\n       c1 + scale_y_log10(limits = c(0.5, 1000)) + scale_x_log10(limits = c(0.5, 1000)) + labs(caption = \"log-log scale\")) %>% pm_grid() + plot_layout(guides = \"collect\") \n##ggsave(here::here(outDir,\"IPRED_DV_by_dose.png\"), width = 10, height = 6)\n\nlist(c2 + xlim(0,maxconc) + ylim(0,maxconc) + labs(caption = \"Linear scale\"),\n       c2 + scale_y_log10(limits = c(0.5, 1000)) + scale_x_log10(limits = c(0.5, 1000)) + labs(caption = \"log-log scale\")) %>% pm_grid() + plot_layout(guides = \"collect\") \n##ggsave(here::here(outDir,\"PRED_DV_by_dose.png\"), width = 10, height = 6)\n\nlist(c3 + xlim(0, maxconc) + ylim(0, maxconc) + labs(caption = \"Linear scale\"),\n       c3 + scale_y_log10(limits = c(0.5, 1000)) + scale_x_log10(limits = c(0.5, 1000)) + labs(caption = \"log-log scale\")) %>% pm_grid() + plot_layout(guides = \"collect\") + guides(color = guide_legend(nrow = 1, title = NULL)) \n##ggsave(here::here(outDir,\"IPRED_DV_by_dose_second.png\"), width = 10, height = 6)\n\nlist(c4 + xlim(0, maxconc) + ylim(0, maxconc) + labs(caption = \"Linear scale\"),\n       c4 + scale_y_log10(limits = c(0.5, 1000)) + scale_x_log10(limits = c(0.5, 1000)) + labs(caption = \"log-log scale\")) %>% pm_grid() + plot_layout(guides = \"collect\") + guides(color = guide_legend(nrow = 1, title = NULL)) \n##ggsave(here::here(outDir,\"PRED_DV_by_dose_second.png\"), width = 10, height = 6)\n\n```\n\n```{r concordance_all, eval=T, echo=F, include=T, warning=F, message=F,dpi=300}\n\nc1 <- dv_pred(pred, yname = \"(mg/mL)\") + theme(plot.margin = unit(c(0.1, 1, 0.1, 0.1), \"cm\"))  \nc2 <- dv_ipred(pred, yname = \"(mg/mL)\") + labs(caption = \"Linear scale\") + theme(plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), \"cm\"))  \n\nlist(c1,c2) %>% pm_grid()\n\nc3 <- dv_pred(pred, yname = \"(mg/mL)\", loglog=TRUE)  + theme(axis.text.x=element_text(size=7.5)) + theme(plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), \"cm\"))  \nc4 <- dv_ipred(pred, yname = \"(mg/mL)\", loglog=TRUE) + theme(axis.text.x=element_text(size=7.5)) + labs(caption = \"Semi-log scale\") + theme(plot.margin = unit(c(0.1, 1, 0.1, 0.1), \"cm\"))  \n\nlist(c3,c4) %>% pm_grid()\nlist(c1,c2,c3,c4) %>% pm_grid() \n\n\n```\n\n## Ceftolozane\n\n```{r concordance_cef, eval=T, echo=F, include=T, warning=F, message=F,dpi=300}\n\nc1 <- dv_pred(pred %>% filter(CMT == 1), yname = \"(mg/mL)\") + theme(plot.margin = unit(c(0.1, 1, 0.1, 0.1), \"cm\"))  \nc2 <- dv_ipred(pred %>% filter(CMT == 1), yname = \"(mg/mL)\") + labs(caption = \"Linear scale\") + theme(plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), \"cm\"))  \n\nlist(c1,c2) %>% pm_grid() + plot_annotation(title = \"Ceftolozane\")\n\nc3 <- dv_pred(pred %>% filter(CMT == 1), yname = \"(mg/mL)\", loglog=TRUE)  + theme(axis.text.x=element_text(size=7.5)) + theme(plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), \"cm\"))  \nc4 <- dv_ipred(pred %>% filter(CMT == 1), yname = \"(mg/mL)\", loglog=TRUE) + theme(axis.text.x=element_text(size=7.5)) + labs(caption = \"Semi-log scale\") + theme(plot.margin = unit(c(0.1, 1, 0.1, 0.1), \"cm\"))  \n\nlist(c3,c4) %>% pm_grid() + plot_annotation(title = \"Ceftolozane\")\nlist(c1,c2,c3,c4) %>% pm_grid() + plot_annotation(title = \"Ceftolozane\")\n\n\n```\n\n## Tazobactam\n\n```{r concordance_taz, eval=T, echo=F, include=T, warning=F, message=F,dpi=300}\n\nc1 <- dv_pred(pred %>% filter(CMT == 3), yname = \"(mg/mL)\") + theme(plot.margin = unit(c(0.1, 1, 0.1, 0.1), \"cm\"))  \nc2 <- dv_ipred(pred %>% filter(CMT == 3), yname = \"(mg/mL)\") + labs(caption = \"Linear scale\") + theme(plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), \"cm\"))  \n\nlist(c1,c2) %>% pm_grid() + plot_annotation(title = \"Tazobactam\")\n\nc3 <- dv_pred(pred %>% filter(CMT == 3), yname = \"(mg/mL)\", loglog=TRUE)  + theme(axis.text.x=element_text(size=7.5)) + theme(plot.margin = unit(c(0.1, 0.1, 0.1, 0.1), \"cm\"))  \nc4 <- dv_ipred(pred %>% filter(CMT == 3), yname = \"(mg/mL)\", loglog=TRUE) + theme(axis.text.x=element_text(size=7.5)) + labs(caption = \"Semi-log scale\") + theme(plot.margin = unit(c(0.1, 1, 0.1, 0.1), \"cm\"))  \n\nlist(c3,c4) %>% pm_grid() + plot_annotation(title = \"Tazobactam\")\nlist(c1,c2,c3,c4) %>% pm_grid() + plot_annotation(title = \"Tazobactam\")\n\n```\n\n# Residual Plots\n\n```{r residual plots, eval=T, echo=F, include=T, warning=F, message=F,fig.width = 10, fig.height = 8, dpi=300}\n#ALL\nsub1 <- sub \n  r1 <- ggplot(sub1, aes(PRED, WRES)) + geom_point(aes(color = as.factor(CMT_f))) + geom_hline(yintercept = 0) + geom_smooth() + labs(y = \"Weighted Residuals\", x = expression(\" \")) + scale_colour_manual(values = drugs)\n  r2 <- ggplot(sub1, aes(PRED, CWRES)) + geom_point(aes(color = as.factor(CMT_f))) + geom_hline(yintercept = 0) + geom_smooth() + labs(y = \"Conditional Weighted Residuals\", x = expression(\" \")) + scale_colour_manual(values = drugs)\n  r3 <- ggplot(sub1, aes(TIME, WRES)) + geom_point(aes(color = as.factor(CMT_f))) + geom_hline(yintercept = 0) + geom_smooth() + labs(y = \" \", x = expression(\" \")) + scale_colour_manual(values = drugs) + scale_x_continuous(breaks = seq(0, 26, by = 4))\n  r4 <- ggplot(sub1, aes(TIME, CWRES)) + geom_point(aes(color = as.factor(CMT_f))) + geom_hline(yintercept = 0) + geom_smooth() + labs(y = \"\", x = \" \") + scale_colour_manual(values = drugs) + scale_x_continuous(breaks = seq(0, 26, by = 4))\n  r5 <- ggplot(sub1, aes(PRED, NPDE)) + geom_point(aes(color = as.factor(CMT_f))) + geom_hline(yintercept = 0) + geom_smooth() + labs(y = \"Normalized prediction distribution errors\", x = expression(\"Population Predicted Concentrations (mg/mL)\")) + scale_colour_manual(values = drugs)\n  r6 <- ggplot(sub1, aes(TIME, NPDE)) + geom_point(aes(color = as.factor(CMT_f))) + geom_hline(yintercept = 0) + geom_smooth() + labs(y = \" \", x = expression(\"Time After Last Dose (hr)\")) + scale_colour_manual(values = drugs) + scale_x_continuous(breaks = seq(0, 26, by = 4))\n \n   list(r1,r3,r2,r4,r5,r6) %>% pm_grid() \n\n#CEF   \nsub1 <- sub %>% filter(CMT == 1)\n  r1 <- ggplot(sub1, aes(PRED, WRES)) + geom_point() + geom_hline(yintercept = 0) + geom_smooth() +\n  labs(y = \"Weighted Residuals\", x = expression(\" \"))\n  r2 <- ggplot(sub1, aes(PRED, CWRES)) + geom_point() + geom_hline(yintercept = 0) + geom_smooth() +\n     labs(y = \"Conditional Weighted Residuals\", x = expression(\" \"))\n  r3 <- ggplot(sub1, aes(TIME, WRES)) + geom_point() + geom_hline(yintercept = 0) + geom_smooth() + labs(y = \" \", x = expression(\" \")) + scale_x_continuous(breaks = seq(0, 26, by = 4))\n  r4 <- ggplot(sub1, aes(TIME, CWRES)) + geom_point() + geom_hline(yintercept = 0) + geom_smooth() +\n     labs(y = \"\", x = \" \") + scale_x_continuous(breaks = seq(0, 26, by = 4))\n  r5 <- ggplot(sub1, aes(PRED, NPDE)) + geom_point() + geom_hline(yintercept = 0) + geom_smooth() + labs(y = \"Normalized prediction distribution errors\", x = expression(\"Population Predicted Concentrations (mg/mL)\"))\n  r6 <- ggplot(sub1, aes(TIME, NPDE)) + geom_point() + geom_hline(yintercept = 0) + geom_smooth() + labs(y = \" \", x = expression(\"Time After First Dose (hr)\")) + scale_x_continuous(breaks = seq(0, 26, by = 4))\n \n   list(r1,r3,r2,r4,r5,r6) %>% pm_grid() + plot_annotation(title = \"Ceftolozane\")\n   \n     \n##ggsave(here::here(outDir,\"residual_plots.png\"), width = 8, height = 6)\n   \n#TAZ \n   sub1 <- sub %>% filter(CMT == 3)\n  r1 <- ggplot(sub1, aes(PRED, WRES)) + geom_point() + geom_hline(yintercept = 0) + geom_smooth() +\n  labs(y = \"Weighted Residuals\", x = expression(\" \"))\n  r2 <- ggplot(sub1, aes(PRED, CWRES)) + geom_point() + geom_hline(yintercept = 0) + geom_smooth() +\n     labs(y = \"Conditional Weighted Residuals\", x = expression(\" \"))\n  r3 <- ggplot(sub1, aes(TIME, WRES)) + geom_point() + geom_hline(yintercept = 0) + geom_smooth() + labs(y = \" \", x = expression(\" \")) + scale_x_continuous(breaks = seq(0, 26, by = 4))\n  r4 <- ggplot(sub1, aes(TIME, CWRES)) + geom_point() + geom_hline(yintercept = 0) + geom_smooth() +\n     labs(y = \"\", x = \" \") + scale_x_continuous(breaks = seq(0, 26, by = 4))\n  r5 <- ggplot(sub1, aes(PRED, NPDE)) + geom_point() + geom_hline(yintercept = 0) + geom_smooth() + labs(y = \"Normalized prediction distribution errors\", x = expression(\"Population Predicted Concentrations (mg/mL)\"))\n  r6 <- ggplot(sub1, aes(TIME, NPDE)) + geom_point() + geom_hline(yintercept = 0) + geom_smooth() + labs(y = \" \", x = expression(\"Time after first dose (hr)\")) + scale_x_continuous(breaks = seq(0, 26, by = 4))\n \n   list(r1,r3,r2,r4,r5,r6) %>% pm_grid() + plot_annotation(title = \"Tazobactam\")\n\n```\n\n```{r resid_plots_final, eval=T, echo=F, include=T, warning=F, message=F,fig.width = 10, fig.height = 8,dpi=300}\n#ALL(single for Report)  \n   sub1 <- sub \n  r1 <- ggplot(sub1, aes(PRED, WRES)) + geom_point(aes(color = as.factor(CMT_f)), size = 2) + geom_hline(yintercept = 0) + geom_smooth() + labs(y = \"Weighted Residuals\", x = \"Population Predicted Concentrations (mg/mL)\") + theme(axis.title.x = element_text(size = 16), axis.text.x = element_text(size = 14),  axis.title.y = element_text(size = 16), axis.text.y = element_text(size = 12), legend.text = element_text(size = 14)) + scale_colour_manual(values = drugs)\n\n    r2 <- ggplot(sub1, aes(PRED, CWRES)) + geom_point(aes(color = as.factor(CMT_f)), size = 2) + geom_hline(yintercept = 0) + geom_smooth() + labs(y = \"Conditional Weighted Residuals\", x = \"Population Predicted Concentrations (mg/mL)\")+ theme(axis.title.x = element_text(size = 16), axis.text.x = element_text(size = 14),  axis.title.y = element_text(size = 16), axis.text.y = element_text(size = 12),legend.text = element_text(size = 14)) + scale_colour_manual(values = drugs)\n\n      r3 <- ggplot(sub1, aes(TIME, WRES)) + geom_point(aes(color = as.factor(CMT_f)), size = 2) + geom_hline(yintercept = 0) + geom_smooth() + labs(y = \"Weighted Residuals\", x = \"Time after first dose (hr)\")+ theme(axis.title.x = element_text(size = 16), axis.text.x = element_text(size = 14),  axis.title.y = element_text(size = 16), axis.text.y = element_text(size = 12), legend.text = element_text(size = 14)) + scale_colour_manual(values = drugs) + scale_x_continuous(breaks = seq(0, 26, by = 4))\n\n        r4 <- ggplot(sub1, aes(TIME, CWRES)) + geom_point(aes(color = as.factor(CMT_f)), size = 2) + geom_hline(yintercept = 0) + geom_smooth() + labs(y = \"Conditional Weighted Residuals\", x = \"Time after first dose (hr)\")+ theme(axis.title.x = element_text(size = 16), axis.text.x = element_text(size = 14),  axis.title.y = element_text(size = 16), axis.text.y = element_text(size = 12),legend.text = element_text(size = 14)) + scale_colour_manual(values = drugs) + scale_x_continuous(breaks = seq(0, 26, by = 4))\n\n          r5 <- ggplot(sub1, aes(PRED, NPDE)) + geom_point(aes(color = as.factor(CMT_f)), size = 2) + geom_hline(yintercept = 0) + geom_smooth() + labs(y = \"Normalized prediction distribution errors\", x = \"Population Predicted Concentrations (mg/mL)\")+ theme(axis.title.x = element_text(size = 16), axis.text.x = element_text(size = 14),  axis.title.y = element_text(size = 16), axis.text.y = element_text(size = 12), legend.text = element_text(size = 14)) + scale_colour_manual(values = drugs)\n\n            r6 <- ggplot(sub1, aes(TIME, NPDE)) + geom_point(aes(color = as.factor(CMT_f)), size = 2) + geom_hline(yintercept = 0) + geom_smooth() + labs(y = \"Normalized prediction distribution errors\", x = \"Time after first dose (hr)\")+ theme(axis.title.x = element_text(size = 16), axis.text.x = element_text(size = 14),  axis.title.y = element_text(size = 16), axis.text.y = element_text(size = 12), legend.text = element_text(size = 14)) + scale_colour_manual(values = drugs) + scale_x_continuous(breaks = seq(0, 26, by = 4))\n\n  r1\n  r2\n  r3\n  r4\n  r5\n  r6\n\n```\n\n# Histogram Plots and Q-Q Plots\n\n```{r histogram plots, eval=T, echo=F, include=T, warning=F, message=F, dpi=300}\n\nset.ETA.labels(etas_est)\neta.hist.GOF(data)\n##ggsave(here::here(outDir, \"hist_ETA.png\"), width = 8, height = 6)\nh1 <- cwres_hist(data)\nh2 <- wres_hist(data)\nh3 <- npde_hist(data)\nlist(h1, h2, h3) %>% pm_grid()\n##ggsave(here::here(outDir, \"hist_WRES_CWRES.png\"), width = 8, height = 6)\neta.qqnorm.GOF(data)\n##ggsave(here::here(outDir, \"QQ_ETA.png\"), width = 8, height = 6)\n\nh4 <-eta_hist(data, etas_est) %>% pm_grid()\nh4\n\nq1<-cwres_q(data)\nq2<-npde_q(data)\nlist(q1, q2) %>% pm_grid()\n\n```\n\n# GOF Plots\n\n## GeoMean\n\n### Linear\n\n```{r gof linear, eval=T, echo=F, include=T, warning=F, message=F, dpi=300}\n\nsub1 <- sub %>% distinct(CMT_f) \n# sub2 <- sub  %>% mutate(BINTIME = floor(TIME + 0.5))\n\nsub2 <- sub  %>% \n  mutate(x = cut_interval(TIME,10)) %>%\n  group_by(x) %>%\n  mutate(NTIME = mean(TIME))\n\n\ngof <- map(seq(1, nrow(sub1)), function(u){\n  temp <- sub2 %>%\n    filter(CMT_f == sub1[u,1]) %>% \n      group_by(NTIME) %>%\n      mutate(GM_OBS = geomean(DV, na.rm = TRUE),\n             GM_IPRED = geomean(IPRED, na.rm = TRUE),\n             GM_PRED = geomean(PRED, na.rm = TRUE))\n \n  g1 <- ggplot(data = temp, aes(x = TIME, y = DV)) +\n    geom_point(color = \"#093129\", size = 0.9) +\n    geom_line(aes(x = NTIME, y = GM_OBS, color = 'GeoMean Observed'), linewidth = 0.9) +\n    geom_line(aes(x = NTIME, y = GM_IPRED, color = 'GeoMean IPRED'), linewidth = 0.9) +\n    geom_line(aes(x = NTIME, y = GM_PRED, color = 'GeoMean PRED'), linewidth = 0.9) +\n    theme(strip.text.x = element_text(size = 12)) +\n    labs(x = \"Time (hours)\", y = \"Concentration (mg/mL)\", title = (sub1[u,1])) +\n    scale_colour_manual(values = gofcol) +\n    scale_x_continuous(breaks = seq(0, 26, by = 4))\n\n\n  g1 + labs(caption = \"Linear scale\")\n})\n\n##ggexport(gof_atfd, filename = here::here(outDir,\"GOF_plots_atfd_lin.png\"), width = 8, height = 5)\ngof\n\n\n# sub %>%   mutate(BINTIME = cut(TIME, \n#                        breaks = seq(0, max(TIME, na.rm = TRUE) + 1, by = 1), \n#                        labels = 0:(length(seq(0, max(TIME, na.rm = TRUE), by = 1)) - 1), \n#                        right = FALSE)) %>% select(TIME, BINTIME) %>% View()\n```\n\n### Semi-log\n\n```{r gof semilog, eval=T, echo=F, include=T, warning=F, message=F, dpi=300}\n\nsub1 <- sub %>% distinct(CMT_f) \ngof <- map(seq(1, nrow(sub1)), function(u){\n  temp <- sub2 %>%\n    filter(CMT_f == sub1[u,1]) %>% \n      group_by(NTIME) %>%\n      mutate(GM_OBS = geomean(DV, na.rm = TRUE),\n             GM_IPRED = geomean(IPRED, na.rm = TRUE),\n             GM_PRED = geomean(PRED, na.rm = TRUE))\n \n  g1 <- ggplot(data = temp, aes(x = TIME, y = DV)) +\n    geom_point(color = \"#093129\", size = 0.9) +\n    geom_line(aes(x = NTIME, y = GM_OBS, color = 'GeoMean Observed'), linewidth = 0.9) +\n    geom_line(aes(x = NTIME, y = GM_IPRED, color = 'GeoMean IPRED'), linewidth = 0.9) +\n    geom_line(aes(x = NTIME, y = GM_PRED, color = 'GeoMean PRED'), linewidth = 0.9) +\n    theme(strip.text.x = element_text(size = 12)) +\n    labs(x = \"Time (hours)\", y = \"Concentration (mg/mL)\", title = (sub1[u,1])) +\n    scale_colour_manual(values = gofcol) +\n    scale_x_continuous(breaks = seq(0, 26, by = 4))\n    \n\n  g1 + scale_y_log10() + \n    #scale_y_continuous(limits = c(0, 100)) + \n    labs(caption = \"Semi-log scale\")\n})\n\n##ggexport(gof_atfd, filename = here::here(outDir,\"GOF_plots_atfd_lin.png\"), width = 8, height = 5)\ngof\n\n\nlegend <- get_legend(gof[[1]] + theme(legend.position = \"right\") + \n                       guides(color = guide_legend(nrow = 1))) \n pm_grid(gof[[1]]/gof[[2]]) + plot_layout(ncol = 1, heights = c(10, 0.01)) + legend + plot_annotation(title = \"\") & theme(legend.position = \"none\")\n\n```\n\n## Median\n\n### Linear\n\n```{r gof linear median, eval=T, echo=F, include=T, warning=F, message=F, dpi=300}\n\nsub1 <- sub %>% distinct(CMT_f) \ngof <- map(seq(1, nrow(sub1)), function(u){\n  temp <- sub2 %>%\n    filter(CMT_f == sub1[u,1]) %>% \n    group_by(NTIME) %>%\n      mutate(MED_OBS = median(DV, na.rm = TRUE),\n             MED_IPRED = median(IPRED, na.rm = TRUE),\n             MED_PRED = median(PRED, na.rm = TRUE)) \n  \n  g1 <- ggplot(data = temp, aes(x = TIME, y = DV)) +\n    geom_point(color = \"#093129\", size = 0.9) +\n    geom_line(aes(x = NTIME, y = MED_OBS, color = 'Median Observed'), linewidth = 0.9) +\n    geom_line(aes(x = NTIME, y = MED_IPRED, color = 'Median IPRED'), linewidth = 0.9) +\n    geom_line(aes(x = NTIME, y = MED_PRED, color = 'Median PRED'), linewidth = 0.9) +\n    theme(strip.text.x = element_text(size = 12)) +\n    labs(x = \"Time (hours)\", y = \"Concentration (mg/mL)\", title = (sub1[u,1])) +\n    scale_colour_manual(values = gofcol2) +\n    scale_x_continuous(breaks = seq(0, 26, by = 4))\n\n\n  g1 + labs(caption = \"Linear scale\")\n})\n\n##ggexport(gof_atfd, filename = here::here(outDir,\"GOF_plots_atfd_lin.png\"), width = 8, height = 5)\ngof\n\n```\n\n### Semi-log\n\n```{r gof semilog median, eval=T, echo=F, include=T, warning=F, message=F, dpi=300}\n\nsub1 <- sub %>% distinct(CMT_f) \ngof <- map(seq(1, nrow(sub1)), function(u){\n  temp <- sub2 %>%\n    filter(CMT_f == sub1[u,1]) %>% \n    group_by(NTIME) %>%\n      mutate(MED_OBS = median(DV, na.rm = TRUE),\n             MED_IPRED = median(IPRED, na.rm = TRUE),\n             MED_PRED = median(PRED, na.rm = TRUE)) \n  \n  g1 <- ggplot(data = temp, aes(x = TIME, y = DV)) +\n    geom_point(color = \"#093129\", size = 0.9) +\n    geom_line(aes(x = NTIME, y = MED_OBS, color = 'Median Observed'), linewidth = 0.9) +\n    geom_line(aes(x = NTIME, y = MED_IPRED, color = 'Median IPRED'), linewidth = 0.9) +\n    geom_line(aes(x = NTIME, y = MED_PRED, color = 'Median PRED'), linewidth = 0.9) +\n    theme(strip.text.x = element_text(size = 12)) +\n    labs(x = \"Time (hours)\", y = \"Concentration (mg/mL)\", title = (sub1[u,1])) +\n    scale_colour_manual(values = gofcol2) +\n    scale_x_continuous(breaks = seq(0, 26, by = 4))\n  \n  \n  g1 + scale_y_log10() + \n    #scale_y_continuous(limits = c(0, 100)) + \n    labs(caption = \"Semi-log scale\")\n})\n\ngof\n##ggexport(gof_atfd, filename = here::here(outDir, \"GOF_plots_atfd_semilog.png\"), width = 8, height = 5)\n\nlegend <- get_legend(gof[[1]] + theme(legend.position = \"right\") + \n                       guides(color = guide_legend(nrow = 1))) \n pm_grid(gof[[1]]/gof[[2]]) + plot_layout(ncol = 1, heights = c(10, 0.01)) + legend + plot_annotation(title = \"\") & theme(legend.position = \"none\")\n```\n\n## Semi-log individual\n\n```{r gof semilog ind, eval=T, echo=F, include=T, warning=F, message=F, dpi=300}\n\nsub1 <- sub %>% distinct(ID) \ngof_ind <- map(seq(1,nrow(sub1)), function(u){\n  temp <- sub2 %>% \n      group_by(NTIME, CMT_f) %>%\n       mutate(GM_OBS = geomean(DV, na.rm = TRUE),\n             GM_IPRED = geomean(IPRED, na.rm = TRUE),\n             GM_PRED = geomean(PRED, na.rm = TRUE)) %>% \n    # select(ID, DV, TIME, GM_OBS:GM_PRED, CMT_f) %>%  \n    # pivot_longer(GM_OBS:GM_PRED, names_to = \"Stats\", values_to = \"Values\") %>% \n    # pivot_wider(names_from = CMT_f, values_from = Values) %>% \n    filter(ID == sub1[u,1]) \n \n  g1 <- ggplot(data = temp, aes(x = TIME, y = DV)) +\n    geom_point(aes(shape = as.factor(CMT_f)), size = 2.5, color = \"grey33\") +\n    geom_line(aes(x = NTIME, y = GM_OBS, color = 'GeoMean Observed', linetype = as.factor(CMT_f)), linewidth = 0.9) +\n    geom_line(aes(x = NTIME, y = GM_IPRED, color = 'GeoMean IPRED', linetype = as.factor(CMT_f)), linewidth = 0.9) +\n    geom_line(aes(x = NTIME, y = GM_PRED, color = 'GeoMean PRED', linetype = as.factor(CMT_f)), linewidth = 0.9) +\n    theme(strip.text.x = element_text(size = 12)) +\n    labs(x = \"Time (hours)\", y = \"Concentration (mg/mL)\", title = paste0(\"Patient no. \", sub1[u,1])) +\n    scale_colour_manual(values = c(drugs, gofcol)) +\n    scale_x_continuous(breaks = seq(0, 26, by = 4)) +\n    guides(col = guide_legend(nrow = 2), linetype = guide_legend(nrow = 2), shape = guide_legend(nrow = 2))\n\n  g1 + scale_y_log10() + labs(caption = \"Semi-log scale\")\n})\n\ngof_ind\n##ggexport(gof_atfd_ind, filename = here::here(outDir, \"GOF_plots_atfd_semilog_individual.png\"), width = 8, height = 5)\n\n```\n\n# ETA Plots\n\n## ETA Correlations\n\n```{r eta correlations, echo = F, warning = F, message = F, dpi=300}\neta_cor <- data  %>% \n  select(ID, starts_with(\"ETA\")) %>%  \n  rename(\"ETA-V1C/F\" = ETA1, \"ETA-CLC/F\" = ETA2, \"ETA-V1T/F-CLT/F\" = ETA3) %>% \n  # rename(\"ETA-V1C/F\" = ETA1, \"ETA-CLC/F\" = ETA2, \"ETA-Q2C/F\" = ETA3, \"ETA-V2C/F\" = ETA4, \"ETA-V1T/F\" = ETA5, \"ETA-CLT/F\" = ETA6, \"ETA-Q2T/F\" = ETA7, \"ETA-V2T/F\" = ETA8) %>% \n  distinct() %>% \n  select(-ID) \n\nplot_eta_cor <- corrplot::corrplot(cor(eta_cor), method = 'circle', type = \"upper\", addCoef.col = 'grey1', cl.pos = 'r',tl.srt=45, tl.col=\"black\")\n\n##ggexport(plot_eta_cor, filename = here::here(outDir, \"ETA Correlations.png\"), width = 8, height = 5)\n \nid <- distinct(sub, ID, .keep_all = T)\netas <-  stringr::str_subset(names(sub), \"ETA\") \np <- eta_pairs(id, etas_est) \np\n\n```\n\n1m## Categorical ETA plots\n\n```{r cat-eta, eval=T, echo=F, include=T, warning=F, message=F, dpi=300}\n\n#Categorical Covariates\ncat_link <- data %>% #filter(ID%in%sub$ID) %>%\n  select(ID, SEX_f, ECMO_f, CRRT_f) %>% \n  distinct(ID, .keep_all = T) %>% \n  group_by(ID) \n\n dat_cat <- data %>% distinct(ID, .keep_all = T) %>% left_join(cat_link)\n \neta_plots_cat <- eta_cat(dat_cat, catcov_labels, etas_est, points = list(width  = 0.1)) \neta_plots_cat\n#ggsave(eta_plots_cat, filename = here::here(outDir,\"ETA_plots_cat.png\"), width = 6, height = 4)\n\neta_plots_cat1 <- eta_cat(dat_cat, catcov_labels, etas_est[1], points = list(width  = 0.1)) %>% pm_grid()\neta_plots_cat1\n##ggsave(eta_plots_cat1, filename = here::here(outDir,\"ETA_plots_cat1.png\"), width = 6, height = 4)\n\neta_plots_cat2 <- eta_cat(dat_cat, catcov_labels, etas_est[2], points = list(width  = 0.1))  %>% pm_grid()\neta_plots_cat2\n##ggsave(eta_plots_cat2, filename = here::here(outDir,\"ETA_plots_cat2.png\"), width = 6, height = 4)\n\neta_plots_cat3 <- eta_cat(dat_cat, catcov_labels, etas_est[3], points = list(width  = 0.1))  %>% pm_grid() \neta_plots_cat3\n##ggsave(eta_plots_cat5, filename = here::here(outDir,\"ETA_plots_cat5.png\"), width = 6, height = 4)\n\n# eta_plots_cat4 <- eta_cat(dat_cat, catcov_labels, etas_est[4], points = list(width  = 0.1))  %>% pm_grid() \n# eta_plots_cat4\n# ##ggsave(eta_plots_cat5, filename = here::here(outDir,\"ETA_plots_cat5.png\"), width = 6, height = 4)\n# \n# eta_plots_cat5 <- eta_cat(dat_cat, catcov_labels, etas_est[5], points = list(width  = 0.1))  %>% pm_grid() \n# eta_plots_cat5\n# ##ggsave(eta_plots_cat5, filename = here::here(outDir,\"ETA_plots_cat5.png\"), width = 6, height = 4)\n# \n# eta_plots_cat6 <- eta_cat(dat_cat, catcov_labels, etas_est[6], points = list(width  = 0.1))  %>% pm_grid() \n# eta_plots_cat6\n# ##ggsave(eta_plots_cat5, filename = here::here(outDir,\"ETA_plots_cat5.png\"), width = 6, height = 4)\n# \n# eta_plots_cat7 <- eta_cat(dat_cat, catcov_labels, etas_est[7], points = list(width  = 0.1))  %>% pm_grid() \n# eta_plots_cat7\n# ##ggsave(eta_plots_cat5, filename = here::here(outDir,\"ETA_plots_cat5.png\"), width = 6, height = 4)\n# \n# eta_plots_cat8 <- eta_cat(dat_cat, catcov_labels, etas_est[8], points = list(width  = 0.1))  %>% pm_grid() \n# eta_plots_cat8\n# ##ggsave(eta_plots_cat5, filename = here::here(outDir,\"ETA_plots_cat5.png\"), width = 6, height = 4)\n# \n\nwrap_cont_cat(dat_cat, catcov_labels, etas_est, points = list(width  = 0.1)) \n\n```\n\n## Continuous ETA plots\n\n```{r cont-eta, eval=T, echo=F, include=T, warning=F, message=F, dpi=300}\n\n#Continuous Covariates\ncont_link <- data %>% filter(ID%in%sub$ID) %>%\n  select(ID, HEIGHT, BW, AGE, SOFA, PCT, ELWI, CI, CRE, ALB, PROTEIN) %>% distinct() %>%  \n mutate_if(is.numeric, ~replace(., .==-999, NA))\ndat_cont <- data %>% distinct(ID, .keep_all = T)  %>% left_join(cont_link)\n\n\neta_plots_cont <- eta_cont(dat_cont, contcov_labels, etas_est) \n##ggexport(eta_plots_cont, filename = here::here(outDir,\"ETA_plots_cont.png\"), width = 6, height = 4)\neta_plots_cont\n\neta_plots_cont1 <- wrap_eta_cont(dat_cont, contcov_labels, etas_est[1],  scales=\"free\",  use_labels=TRUE)  \n##ggexport(eta_plots_cont1, filename = here::here(outDir,\"ETA_plots_cont_CL.png\"), width = 6, height = 4)\neta_plots_cont1\n\neta_plots_cont2 <- wrap_eta_cont(dat_cont, contcov_labels, etas_est[2],  scales=\"free\",  use_labels=TRUE) \n##ggexport(eta_plots_cont2, filename = here::here(outDir,\"ETA_plots_cont_VC.png\"), width = 6, height = 4)\neta_plots_cont2\n\neta_plots_cont3 <- wrap_eta_cont(dat_cont, contcov_labels, etas_est[3],  scales=\"free\",  use_labels=TRUE)  \n##ggexport(eta_plots_cont5, filename = here::here(outDir,\"ETA_plots_cont_KA.png\"), width = 6, height = 4)\neta_plots_cont3\n\n# eta_plots_cont4 <- wrap_eta_cont(dat_cont, contcov_labels, etas_est[4],  scales=\"free\",  use_labels=TRUE)  \n# ##ggexport(eta_plots_cont5, filename = here::here(outDir,\"ETA_plots_cont_KA.png\"), width = 6, height = 4)\n# eta_plots_cont4\n# \n# eta_plots_cont5 <- wrap_eta_cont(dat_cont, contcov_labels, etas_est[5],  scales=\"free\",  use_labels=TRUE)  \n# ##ggexport(eta_plots_cont5, filename = here::here(outDir,\"ETA_plots_cont_KA.png\"), width = 6, height = 4)\n# eta_plots_cont5\n# \n# eta_plots_cont6 <- wrap_eta_cont(dat_cont, contcov_labels, etas_est[6],  scales=\"free\",  use_labels=TRUE)  \n# ##ggexport(eta_plots_cont5, filename = here::here(outDir,\"ETA_plots_cont_KA.png\"), width = 6, height = 4)\n# eta_plots_cont6\n# \n# eta_plots_cont7 <- wrap_eta_cont(dat_cont, contcov_labels, etas_est[7],  scales=\"free\",  use_labels=TRUE) \n# ##ggexport(eta_plots_cont5, filename = here::here(outDir,\"ETA_plots_cont_KA.png\"), width = 6, height = 4)\n# eta_plots_cont7\n# \n# eta_plots_cont8 <- wrap_eta_cont(dat_cont, contcov_labels, etas_est[8],  scales=\"free\",  use_labels=TRUE)  \n# ##ggexport(eta_plots_cont5, filename = here::here(outDir,\"ETA_plots_cont_KA.png\"), width = 6, height = 4)\n# eta_plots_cont8\n\n# map2(.x = contcov_labels, .y = contcov_vars, \n#      function(xlab, yvar){eta_cont(eta %>% filter(eta[[yvar]]>0), x=xlab , y =etas_est) %>% pm_grid()\n# })\n\n```\n\n# Sesion info\n\n```{r sessioninfo, echo = FALSE, include=TRUE, warning=F, message=F}\n\nsessionInfo()\n\n```\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":false,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":true,"code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","toc":true,"number-sections":true,"output-file":"model_diagnostic.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.7.32","title":"Ceftolozane-Tazobactam Model Diagnostic","author":"Paulina Okunska","date":"today","editor":"visual","theme":"flatly","colorlinks":true},"extensions":{"book":{"multiFile":true}}}},"projectFormats":[]}